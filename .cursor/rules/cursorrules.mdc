---
alwaysApply: true
---
**√öltima actualizaci√≥n**: Diciembre 2025
**Versi√≥n del proyecto**: v0.1.1


---
alwaysApply: true
---
# Reglas del Proyecto AMVA Digital

## üìã Estructura del Proyecto

Este es un monorepo con:
- **Frontend**: Next.js 16 (App Router) + React 19 + TypeScript
- **Backend**: NestJS + Prisma + PostgreSQL (Neon)
- **Mobile**: React Native (Expo) - en `amva-mobile/`

### Estructura de Carpetas

```
/
‚îú‚îÄ‚îÄ app/                    # Next.js App Router (p√°ginas)
‚îÇ   ‚îú‚îÄ‚îÄ admin/             # Panel administrativo
‚îÇ   ‚îú‚îÄ‚îÄ convencion/        # P√°ginas p√∫blicas de convenciones
‚îÇ   ‚îî‚îÄ‚îÄ noticias/          # P√°ginas p√∫blicas de noticias
‚îú‚îÄ‚îÄ components/            # Componentes React reutilizables
‚îÇ   ‚îú‚îÄ‚îÄ admin/            # Componentes del panel admin (modularizados)
‚îÇ   ‚îú‚îÄ‚îÄ ui/               # Componentes UI base (shadcn/ui)
‚îÇ   ‚îî‚îÄ‚îÄ [feature]/        # Componentes por feature
‚îú‚îÄ‚îÄ lib/                  # Utilidades y configuraciones
‚îÇ   ‚îú‚îÄ‚îÄ api/              # Clientes API (axios)
‚îÇ   ‚îú‚îÄ‚îÄ hooks/            # Custom React hooks
‚îÇ   ‚îî‚îÄ‚îÄ utils/            # Funciones utilitarias
‚îú‚îÄ‚îÄ backend/              # Backend NestJS
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modules/      # M√≥dulos NestJS (auth, inscripciones, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/       # Servicios y utilidades compartidas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prisma/       # Configuraci√≥n Prisma
‚îÇ   ‚îî‚îÄ‚îÄ prisma/           # Schema y migraciones
‚îî‚îÄ‚îÄ amva-mobile/          # App m√≥vil React Native
```

## üéØ Stack Tecnol√≥gico

### Frontend
- **Framework**: Next.js 16 (App Router)
- **UI**: React 19, Tailwind CSS, shadcn/ui (Radix UI)
- **Estado**: Zustand (auth), React Query (data fetching)
- **Formularios**: React Hook Form + Zod
- **Notificaciones**: Sonner (toast)
- **Iconos**: Lucide React

### Backend
- **Framework**: NestJS 10
- **ORM**: Prisma 5
- **Base de Datos**: PostgreSQL (Neon)
- **Autenticaci√≥n**: JWT (Passport.js)
- **Validaci√≥n**: class-validator + class-transformer
- **Colas**: Bull + Redis (notificaciones)
- **WebSockets**: Socket.io (notificaciones en tiempo real)
- **Upload**: Cloudinary + Multer
- **Email**: Nodemailer + SendGrid

## üìù Convenciones de C√≥digo

### TypeScript

1. **Strict Mode Gradual**: Habilitar opciones estrictas gradualmente
   - ‚úÖ `strictNullChecks: true`
   - ‚úÖ `noImplicitAny: true`
   - ‚úÖ `strictFunctionTypes: true`
   - ‚úÖ `noImplicitReturns: true`
   - ‚ö†Ô∏è `strictPropertyInitialization: false` (temporal)
   - ‚ö†Ô∏è `noUnusedLocals: false` (temporal)

2. **Eliminar `any`**: Siempre usar tipos espec√≠ficos o `unknown` con type guards
   ```typescript
   // ‚ùå MAL
   function process(data: any) { }
   
   // ‚úÖ BIEN
   function process(data: unknown) {
     if (typeof data === 'string') { }
   }
   ```

3. **Tipos Prisma**: Usar tipos generados de Prisma
   ```typescript
   import { Inscripcion, Pago } from '@prisma/client'
   import { Prisma } from '@prisma/client'
   ```

4. **Request Types**: Usar tipos espec√≠ficos para requests autenticados
   ```typescript
   import { AuthenticatedRequest } from '../auth/types/request.types'
   ```

### React/Next.js

1. **Componentes**: Usar `'use client'` solo cuando sea necesario
   - P√°ginas del admin: `'use client'`
   - Componentes UI: `'use client'` si usan hooks
   - Layouts: Sin `'use client'` si es posible

2. **Modularizaci√≥n**: Componentes grandes deben dividirse
   - M√°ximo ~300-400 l√≠neas por componente
   - Extraer l√≥gica a custom hooks
   - Usar barrel exports (`index.ts`)

3. **Hooks Personalizados**: 
   - Prefijo `use` (ej: `useInscripciones`, `usePagos`)
   - Encapsular l√≥gica de React Query
   - Usar `useSmartSync` para sincronizaci√≥n entre pesta√±as

4. **Nombres de Componentes**: PascalCase
   ```typescript
   // ‚úÖ BIEN
   export function PagosStatsDashboard() { }
   export function EditarInscripcionDialog() { }
   ```

5. **Props**: Usar interfaces para props
   ```typescript
   interface ComponentProps {
     id: string
     onUpdate?: (data: Data) => void
   }
   ```

### NestJS

1. **Estructura de M√≥dulos**:
   ```
   modules/
   ‚îú‚îÄ‚îÄ [feature]/
   ‚îÇ   ‚îú‚îÄ‚îÄ [feature].module.ts
   ‚îÇ   ‚îú‚îÄ‚îÄ [feature].controller.ts
   ‚îÇ   ‚îú‚îÄ‚îÄ [feature].service.ts
   ‚îÇ   ‚îú‚îÄ‚îÄ dto/
   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [feature].dto.ts
   ‚îÇ   ‚îî‚îÄ‚îÄ types/
   ‚îÇ       ‚îî‚îÄ‚îÄ [feature].types.ts
   ```

2. **DTOs**: 
   - Usar `class-validator` para validaci√≥n
   - Usar `@IsOptional()` para campos opcionales
   - Usar `@ValidateIf()` para validaciones condicionales
   - Agregar `!` (definite assignment) si es necesario

3. **Servicios**:
   - Inyectar `PrismaService` y otros servicios
   - Usar `Logger` para logs
   - Manejar errores con try/catch
   - Usar `unknown` para errores, no `any`

4. **Controladores**:
   - Usar guards (`@UseGuards(JwtAuthGuard)`)
   - Usar decoradores de validaci√≥n (`@Body()`, `@Param()`)
   - Tipar `req` con `AuthenticatedRequest`

5. **Eventos**: Usar EventEmitter2 para eventos as√≠ncronos
   ```typescript
   this.eventEmitter.emit(NotificationEventType.PAGO_VALIDADO, event)
   ```

## üé® Estilo y Formato

### Prettier
- Sin punto y coma (`semi: false`)
- Comillas simples (`singleQuote: true`)
- 2 espacios de indentaci√≥n
- 100 caracteres de ancho m√°ximo
- `proseWrap: "preserve"` (no agregar l√≠neas en blanco innecesarias)

### Nombres de Archivos
- **Componentes**: kebab-case (ej: `pagos-stats-dashboard.tsx`)
- **Hooks**: kebab-case (ej: `use-inscripciones.ts`)
- **Servicios Backend**: kebab-case (ej: `inscripciones.service.ts`)
- **DTOs**: kebab-case (ej: `inscripcion.dto.ts`)

### Nombres de Variables/Funciones
- **Variables**: camelCase
- **Funciones**: camelCase
- **Constantes**: UPPER_SNAKE_CASE
- **Tipos/Interfaces**: PascalCase
- **Enums**: PascalCase

## üîê Autenticaci√≥n y Autorizaci√≥n

1. **Tres tipos de usuarios**:
   - **Admin**: Panel administrativo (`/admin/*`)
   - **Pastor**: App m√≥vil (endpoints `/auth/pastor/*`)
   - **Invitado**: Web p√∫blica (endpoints `/auth/invitado/*`)

2. **Guards**:
   - `JwtAuthGuard`: Para admins
   - `PastorJwtAuthGuard`: Para pastores
   - `InvitadoJwtAuthGuard`: Para invitados

3. **Refresh Tokens**:
   - Admins: `/api/auth/refresh`
   - Pastores: `/api/auth/pastor/refresh` (IMPORTANTE: no `/api/auth/refresh`)
   - Invitados: `/api/auth/invitado/refresh`

## üìä Base de Datos (Prisma)

1. **Modelos principales**:
   - `User`: Administradores
   - `Pastor`: Estructura organizacional
   - `Invitado`: Participantes de convenciones
   - `Convencion`: Eventos/convenciones
   - `Inscripcion`: Registros a convenciones
   - `Pago`: Pagos de inscripciones
   - `NotificationHistory`: Historial de notificaciones

2. **Relaciones importantes**:
   - `Inscripcion` ‚Üí `Convencion` (many-to-one)
   - `Inscripcion` ‚Üí `Pago` (one-to-many)
   - `Inscripcion` ‚Üí `Invitado` (many-to-one)

3. **Origen de Registro**: Campo `origenRegistro` en `Inscripcion`
   - `'web'`: Desde landing page
   - `'dashboard'`: Desde panel admin
   - `'mobile'`: Desde app m√≥vil

## üîî Notificaciones

1. **Sistema de Notificaciones**:
   - Eventos as√≠ncronos con EventEmitter2
   - Cola de procesamiento con Bull
   - WebSockets para tiempo real (Socket.io)
   - Email con templates personalizados
   - Push notifications (Expo)

2. **Notificaciones para Admins**:
   - Se guardan en `NotificationHistory` (b√∫squeda por email)
   - Se env√≠an v√≠a `sendNotificationToAdmin()` en `NotificationsService`
   - Aparecen en la campanita del header (`NotificationsBell`)
   - WebSocket se conecta autom√°ticamente al autenticarse
   - Contador de no le√≠das se actualiza en tiempo real

3. **Tipos de Notificaciones**:
   - `nueva_inscripcion`: Cuando se crea una inscripci√≥n nueva
   - `pago_validado`: Cuando un admin valida un pago
   - `pago_rechazado`: Cuando un admin rechaza un pago
   - `pago_rehabilitado`: Cuando se rehabilita un pago rechazado
   - `inscripcion_confirmada`: Cuando todas las cuotas est√°n pagadas
   - `pago_recordatorio`: Recordatorio de pagos pendientes

4. **Eventos de Notificaciones**:
   - Todos los eventos deben incluir `nombre` y `apellido` en `data`
   - El constructor genera `inscripcionNombre` autom√°ticamente
   - Ejemplo: `PagoValidadoEvent`, `InscripcionCreadaEvent`, `InscripcionConfirmadaEvent`

5. **Templates de Email Personalizados**:
   - Todos los templates usan el nombre real del usuario
   - L√≥gica: `inscripcionNombre` ‚Üí `nombre + apellido` ‚Üí `nombre` ‚Üí `'Estimado/a participante'`
   - Templates personalizados: `getPagoValidadoTemplate`, `getInscripcionCreadaTemplate`, `getInscripcionConfirmadaTemplate`, `getPagoRecordatorioTemplate`

6. **WebSocket Notifications**:
   - Hook: `useWebSocketNotifications()` en frontend
   - Gateway: `NotificationsGateway` en backend
   - Token: Se obtiene de `localStorage.getItem('auth_token')`
   - Eventos: `notification`, `unread-count`, `connect`, `disconnect`
   - Invalidaci√≥n autom√°tica de queries al conectar/reconectar

7. **getUnreadCount**:
   - Busca primero si es admin (por email en `NotificationHistory`)
   - Luego busca si es pastor (por `pastorId`)
   - Retorna 0 si no encuentra usuario
   - Logging para debugging

## üéØ Patrones de Dise√±o

### Frontend
1. **Barrel Exports**: Usar `index.ts` para exportar componentes
   ```typescript
   // components/admin/pagos/index.ts
   export { PagosHeader } from './pagos-header'
   export { PagosStatsDashboard } from './pagos-stats-dashboard'
   ```

2. **Custom Hooks**: Encapsular l√≥gica de React Query
   ```typescript
   export function usePagos(page, limit, filters) {
     return useQuery({
       queryKey: ['pagos', page, limit, filters],
       queryFn: () => pagosApi.getAllPagos(page, limit, filters),
     })
   }
   ```

3. **Smart Sync**: Sincronizaci√≥n entre pesta√±as
   ```typescript
   useSmartSync() // En hooks que necesitan sincronizaci√≥n
   ```

### Backend
1. **BaseService**: Servicios CRUD gen√©ricos
   ```typescript
   export class PastoresService extends BaseService<Pastor, CreatePastorDto, UpdatePastorDto>
   ```

2. **Repository Pattern**: Para acceso a datos complejos
   ```typescript
   export class ConvencionRepository { }
   ```

3. **Event-Driven**: Usar eventos para acciones as√≠ncronas
   ```typescript
   @OnEvent(NotificationEventType.PAGO_VALIDADO)
   async handlePagoValidado(event: PagoValidadoEvent) { }
   ```

## üö´ Reglas de NO Hacer

1. **NO usar `any`**: Siempre usar tipos espec√≠ficos o `unknown`
2. **NO crear archivos temporales**: Eliminar `.original.tsx`, `.refactored.tsx`
3. **NO crear docs innecesarios**: Solo documentaci√≥n esencial
4. **NO mezclar l√≥gica de negocio en componentes**: Usar hooks o servicios
5. **NO hardcodear valores**: Usar variables de entorno
6. **NO ignorar errores**: Siempre manejar con try/catch y logging
7. **NO crear componentes > 400 l√≠neas**: Modularizar

## ‚úÖ Mejores Pr√°cticas

1. **Error Handling**:
   ```typescript
   try {
     // c√≥digo
   } catch (error: unknown) {
     const errorMessage = error instanceof Error ? error.message : 'Error desconocido'
     this.logger.error('Error:', errorMessage)
     throw error
   }
   ```

2. **Null Checks**:
   ```typescript
   if (!inscripcion || !inscripcion.email) {
     return
   }
   ```

3. **Type Guards**:
   ```typescript
   function isString(value: unknown): value is string {
     return typeof value === 'string'
   }
   ```

4. **Logging**: Usar Logger de NestJS en backend
   ```typescript
   this.logger.log('‚úÖ Operaci√≥n exitosa')
   this.logger.error('‚ùå Error:', error)
   ```

5. **Validaci√≥n**: Validar en frontend Y backend
   - Frontend: React Hook Form + Zod
   - Backend: class-validator

## üì¶ Imports

1. **Orden de imports**:
   ```typescript
   // 1. React/Next.js
   import { useState, useEffect } from 'react'
   
   // 2. Librer√≠as externas
   import { toast } from 'sonner'
   
   // 3. Componentes UI
   import { Button } from '@/components/ui/button'
   
   // 4. Componentes del proyecto
   import { PagosHeader } from '@/components/admin/pagos'
   
   // 5. Hooks
   import { usePagos } from '@/lib/hooks/use-pagos'
   
   // 6. Utilidades
   import { cn } from '@/lib/utils'
   ```

2. **Path Aliases**: Usar `@/` para imports absolutos
   - `@/components` ‚Üí `components/`
   - `@/lib` ‚Üí `lib/`
   - `@/app` ‚Üí `app/`

## üîÑ Flujos Importantes

### Inscripciones
1. Usuario se inscribe desde web ‚Üí `origenRegistro: 'web'`
2. Se crea `Inscripcion` y `Invitado` (si no existe)
3. Se crean pagos autom√°ticamente (3 cuotas por defecto)
4. Se env√≠a notificaci√≥n a admins
5. Admin valida pagos ‚Üí se env√≠a notificaci√≥n al usuario

### Pagos
1. Usuario sube comprobante (drag & drop mejorado)
2. Admin valida/rechaza pago
3. Se env√≠a notificaci√≥n al usuario Y a todos los admins (v√≠a `sendNotificationToAdmin`)
4. Notificaciones aparecen en la campanita del header
5. Si todas las cuotas pagadas ‚Üí inscripci√≥n confirmada (con email personalizado)

## üé® UI/UX

1. **Componentes UI**: Usar shadcn/ui como base
2. **Temas**: Soporte dark/light mode
3. **Responsive**: Mobile-first approach
4. **Loading States**: Siempre mostrar skeletons o spinners
5. **Error States**: Mostrar mensajes claros con toast (Sonner)
6. **Feedback Visual**: Usar badges, icons, colores sem√°nticos
7. **Tablas Optimizadas**:
   - Usar `table-auto` o `table-fixed` con `<colgroup>` para control de anchos
   - Padding reducido (`p-2` en lugar de `p-3`) para tablas compactas
   - Tama√±os de fuente reducidos (`text-xs`, `text-[10px]`) para m√°s informaci√≥n
   - Sin scroll lateral: ajustar anchos de columnas para que quepan en el viewport
   - Badges y botones compactos para tablas con muchas columnas

## üìù Comentarios y Documentaci√≥n

1. **JSDoc**: Para funciones complejas
   ```typescript
   /**
    * Actualiza una inscripci√≥n
    * @param id - ID de la inscripci√≥n
    * @param dto - Datos a actualizar
    * @returns Inscripci√≥n actualizada
    */
   ```

2. **Comentarios**: Explicar el "por qu√©", no el "qu√©"
3. **README**: Mantener actualizado en cada m√≥dulo importante

## üîç Debugging

1. **Console Logs**: Usar prefijos descriptivos
   ```typescript
   console.log('[PagosPage] Respuesta recibida:', data)
   this.logger.log('‚úÖ Pago validado:', id)
   ```

2. **Error Messages**: Ser espec√≠ficos y √∫tiles
   ```typescript
   throw new BadRequestException('El correo ya est√° inscrito en esta convenci√≥n')
   ```

## üöÄ Performance

1. **React Query**: Usar `placeholderData` para evitar parpadeos
2. **Lazy Loading**: Cargar componentes pesados con `dynamic()`
3. **Image Optimization**: Usar `next/image` siempre
4. **Code Splitting**: Next.js lo hace autom√°ticamente

## üîí Seguridad

1. **Validaci√≥n**: Siempre validar en backend, frontend es UX
2. **Sanitizaci√≥n**: Sanitizar inputs antes de guardar
3. **Rate Limiting**: Usar ThrottlerModule en NestJS
4. **JWT Secrets**: M√≠nimo 32 caracteres en producci√≥n
5. **CORS**: Configurado en `main.ts`

## üìã Checklist para Nuevas Features

- [ ] Crear tipos TypeScript apropiados
- [ ] Validar en frontend (Zod) y backend (class-validator)
- [ ] Manejar errores apropiadamente
- [ ] Agregar logging
- [ ] Agregar notificaciones si aplica
- [ ] Modularizar componentes grandes
- [ ] Usar barrel exports
- [ ] Agregar loading/error states
- [ ] Probar en dark/light mode
- [ ] Verificar responsive

## üéØ Prioridades del Proyecto

1. **TypeScript Strict**: Habilitar gradualmente opciones estrictas ‚úÖ
2. **Modularizaci√≥n**: Dividir componentes grandes ‚úÖ
3. **Eliminar `any`**: Reemplazar con tipos espec√≠ficos ‚úÖ (en progreso)
4. **Notificaciones**: Sistema de notificaciones mejorado ‚úÖ
   - Campanita funcionando con WebSocket
   - Notificaciones para: inscripciones, pagos validados, pagos rechazados
   - Templates de email personalizados con nombres reales
5. **Mercado Pago**: Integraci√≥n opcional (Fase 2)

---

## üìß Templates de Email

1. **Personalizaci√≥n con Nombres Reales**:
   - Todos los templates deben usar el nombre real del usuario
   - L√≥gica de fallback: `inscripcionNombre` ‚Üí `nombre + apellido` ‚Üí `nombre` ‚Üí `'Estimado/a participante'`
   - Eventos deben incluir `nombre` y `apellido` en `data`

2. **Templates Disponibles**:
   - `getPagoValidadoTemplate`: Pago validado exitosamente
   - `getPagoRechazadoTemplate`: Pago rechazado con motivo
   - `getPagoRehabilitadoTemplate`: Pago rehabilitado
   - `getPagoRecordatorioTemplate`: Recordatorio de pagos pendientes (dise√±o urgente con alertas)
   - `getInscripcionCreadaTemplate`: Inscripci√≥n recibida exitosamente
   - `getInscripcionConfirmadaTemplate`: Inscripci√≥n confirmada (todas las cuotas pagadas)
   - `getInscripcionCanceladaTemplate`: Inscripci√≥n cancelada
   - `getInscripcionActualizadaTemplate`: Inscripci√≥n actualizada

3. **Tipos de Notificaciones en Templates**:
   - `pago_validado`: Tipo correcto (no `pagoValidado`)
   - `pago_rechazado`: Tipo correcto (no `pagoRechazado`)
   - `pago_recordatorio`: Tipo correcto (no `recordatorio_pago`)
   - `inscripcion_creada`: Tipo correcto
   - `inscripcion_confirmada`: Tipo correcto

## üé® Optimizaci√≥n de Tablas

1. **Tablas sin Scroll Lateral**:
   - Usar `<colgroup>` con anchos espec√≠ficos para cada columna
   - Padding reducido: `p-2` en lugar de `p-3`
   - Tama√±os de fuente: `text-xs` o `text-[10px]` para contenido compacto
   - Badges compactos: `text-[10px] px-1.5 py-0.5`
   - Botones peque√±os: `h-7 text-[10px] px-2`
   - Iconos reducidos: `size-3` o `size-4`

2. **Ejemplo de Tabla Optimizada**:
   ```tsx
   <table className="w-full table-auto">
     <colgroup>
       <col className="w-[40px]" />
       <col className="w-[160px]" />
       {/* m√°s columnas */}
     </colgroup>
     <thead>
       <tr>
         <th className="p-2 text-xs font-medium">Columna</th>
       </tr>
     </thead>
   </table>
   ```

---

## üîç AUDITOR√çA Y CALIDAD DE C√ìDIGO

### Auditor√≠a del Service Layer (CR√çTICO)

1. **BaseService Obligatorio**:
   - ‚úÖ Todos los servicios deben extender `BaseService<T, CreateDto, UpdateDto>` cuando sea posible
   - ‚úÖ Servicios que no extienden BaseService deben tener justificaci√≥n clara
   - ‚úÖ Usar `PrismaModelDelegate<T>` para tipado del modelo
   - ‚úÖ Ejemplo: `PastoresService extends BaseService<Pastor, CreatePastorDto, UpdatePastorDto>`

2. **Logger Obligatorio**:
   - ‚úÖ Todos los servicios deben inyectar `Logger` de NestJS
   - ‚úÖ Usar `this.logger.log()`, `this.logger.error()`, `this.logger.warn()`
   - ‚ùå NUNCA usar `console.log()`, `console.error()`, `console.warn()` en servicios backend
   - ‚úÖ En frontend, usar `console.log()` solo para debugging temporal (marcar con `// TODO: remove`)

3. **Validaci√≥n de Servicios**:
   ```bash
   # Buscar console.log en servicios backend
   grep -r "console\." backend/src/modules/
   
   # Verificar que todos extienden BaseService
   grep -r "extends BaseService" backend/src/modules/
   ```

4. **Tipos Expl√≠citos**:
   - ‚úÖ Todos los m√©todos de servicios deben tener tipos expl√≠citos de par√°metros y retornos
   - ‚úÖ No usar `any`, usar `unknown` con type guards si es necesario
   - ‚úÖ Usar tipos generados de Prisma: `import { Inscripcion, Pago } from '@prisma/client'`

5. **Exportaci√≥n de Servicios**:
   - ‚úÖ Todos los servicios deben estar exportados desde el m√≥dulo correspondiente
   - ‚úÖ Usar barrel exports cuando sea apropiado

### Auditor√≠a de Patrones de Componentes

1. **Detecci√≥n de Duplicaciones**:
   - ‚úÖ Buscar componentes duplicados con nombres similares
   - ‚úÖ Revisar tablas, formularios, dialogs, cards y detail views
   - ‚úÖ Marcar duplicaciones como P1 (prioridad alta)
   - ‚úÖ Consolidar componentes similares en componentes reutilizables

2. **Comandos de Auditor√≠a**:
   ```bash
   # Buscar componentes duplicados
   find components -name "*table*.tsx" -o -name "*form*.tsx" -o -name "*dialog*.tsx"
   
   # Buscar archivos con nombres similares
   find components -type f | sort | uniq -d
   ```

3. **Modularizaci√≥n**:
   - ‚úÖ Componentes > 400 l√≠neas deben dividirse
   - ‚úÖ Extraer l√≥gica a custom hooks
   - ‚úÖ Usar barrel exports (`index.ts`)

### Revisi√≥n de Hooks

1. **No usar console.log**:
   - ‚ö†Ô∏è En hooks de producci√≥n, evitar `console.log()`
   - ‚úÖ Usar solo para debugging temporal (marcar con `// TODO: remove`)
   - ‚úÖ En desarrollo, usar prefijos descriptivos: `console.log('[HookName] Mensaje:', data)`

2. **No usar API directa en hooks**:
   - ‚úÖ Usar servicios de `lib/api/` en lugar de llamadas directas
   - ‚úÖ Encapsular l√≥gica de React Query en hooks personalizados
   - ‚úÖ Ejemplo: `usePagos()` usa `pagosApi.getAllPagos()`

3. **Jerarqu√≠a de Query Keys**:
   - ‚úÖ Usar estructura consistente: `['feature', 'subfeature', id]`
   - ‚úÖ Ejemplo: `['pagos', page, limit, filters]`
   - ‚úÖ Usar `queryClient.invalidateQueries()` para invalidaci√≥n

4. **Tipos Retornados Expl√≠citos**:
   - ‚úÖ Todos los hooks deben tener tipos expl√≠citos de retorno
   - ‚úÖ Usar tipos de React Query: `UseQueryResult<T>`, `UseMutationResult<T>`

5. **Manejo de Errores**:
   - ‚úÖ Usar `onError` en React Query mutations
   - ‚úÖ Mostrar errores con `toast.error()` de Sonner
   - ‚úÖ No silenciar errores

### Revisi√≥n de Componentes

1. **Interfaces de Props Obligatorias**:
   - ‚úÖ Todos los componentes deben tener interfaces para props
   - ‚úÖ Usar nombres descriptivos: `ComponentNameProps`
   - ‚ùå NUNCA usar `any` en props

2. **Optimizaci√≥n de Rendimiento**:
   - ‚úÖ Usar `useCallback` para funciones pasadas como props
   - ‚úÖ Usar `useMemo` para c√°lculos costosos
   - ‚úÖ Usar `React.memo` en componentes que reciben props que no cambian frecuentemente
   - ‚úÖ Ejemplo: `export const PagosTable = React.memo(PagosTableComponent)`

3. **Estados de Loading y Empty**:
   - ‚úÖ Siempre mostrar estados de loading (skeletons o spinners)
   - ‚úÖ Mostrar estados vac√≠os con mensajes claros
   - ‚úÖ Usar componentes `Skeleton` de shadcn/ui

4. **Validaci√≥n de Componentes**:
   ```bash
   # Buscar componentes sin interfaces de props
   grep -r "export.*function.*(" components --include="*.tsx" | grep -v "interface"
   
   # Buscar uso de any en props
   grep -r ": any" components --include="*.tsx"
   ```

### Revisi√≥n Arquitect√≥nica

1. **Flujo Obligatorio**:
   ```
   Screen/Page ‚Üí Component ‚Üí Hook ‚Üí Service (lib/api/) ‚Üí Backend Endpoint ‚Üí Database
   ```
   - ‚úÖ Las p√°ginas (`app/`) solo deben renderizar componentes
   - ‚úÖ Los componentes usan hooks para obtener datos
   - ‚úÖ Los hooks usan servicios de `lib/api/`
   - ‚úÖ Los servicios hacen llamadas HTTP al backend
   - ‚úÖ El backend accede a la base de datos con Prisma

2. **Servicios Backend**:
   - ‚úÖ Deben extender `BaseService` cuando sea posible
   - ‚úÖ Usar `PrismaService` para acceso a datos
   - ‚úÖ Inyectar `Logger` para logging
   - ‚úÖ Usar DTOs para validaci√≥n

3. **Rutas API**:
   - ‚úÖ Backend: Usar estructura `/api/[feature]` (ej: `/api/pagos`, `/api/inscripciones`)
   - ‚úÖ Frontend: Clientes API en `lib/api/[feature].ts`
   - ‚úÖ Usar axios con configuraci√≥n centralizada

4. **Acceso a Base de Datos**:
   - ‚úÖ Usar Prisma ORM siempre (no SQL crudo)
   - ‚úÖ Usar tipos generados de Prisma
   - ‚úÖ Usar transacciones para operaciones complejas

### C√≥digo No Usado

1. **Imports Sin Usar**:
   - ‚ùå NO dejar imports sin usar
   - ‚úÖ Ejecutar `npm run lint` para detectar
   - ‚úÖ Usar ESLint con regla `@typescript-eslint/no-unused-vars`

2. **Variables Sin Usar**:
   - ‚ùå NO dejar variables sin usar
   - ‚úÖ Prefijar con `_` si son necesarias pero no usadas: `const _unused = value`
   - ‚úÖ Eliminar c√≥digo muerto

3. **C√≥digo Comentado**:
   - ‚ùå NO dejar c√≥digo comentado sin prop√≥sito
   - ‚úÖ Si es temporal, marcar con `// TODO: remove` y fecha
   - ‚úÖ Si es documentaci√≥n, usar JSDoc

4. **Comandos de Verificaci√≥n**:
   ```bash
   # Verificar TypeScript
   npm run build
   
   # Verificar linting
   npm run lint
   
   # Buscar c√≥digo comentado
   grep -r "^[[:space:]]*//.*[a-zA-Z]" --include="*.ts" --include="*.tsx" | grep -v "TODO\|FIXME\|NOTE"
   ```

### Checklist de Auditor√≠a Peri√≥dica

- [ ] Verificar que todos los servicios extienden BaseService (o tienen justificaci√≥n)
- [ ] Buscar y eliminar `console.log()` en producci√≥n
- [ ] Verificar que todos los servicios usan `Logger`
- [ ] Buscar componentes duplicados
- [ ] Verificar interfaces de props en todos los componentes
- [ ] Buscar uso de `any` en c√≥digo
- [ ] Verificar que hooks usan servicios, no llamadas directas
- [ ] Ejecutar `npm run lint` y corregir errores
- [ ] Ejecutar `npm run build` y corregir errores TypeScript
- [ ] Eliminar c√≥digo comentado sin prop√≥sito
- [ ] Eliminar imports y variables sin usar

---

## üèóÔ∏è ARQUITECTURA Y DISE√ëO

### Patr√≥n en Capas (Obligatorio)

El proyecto debe seguir estrictamente este patr√≥n en capas:

```
Screen:     /app/[feature]/page.tsx
Component:  /components/[feature]/
Hook:       /lib/hooks/use-[feature].ts
Service:    /lib/api/[feature].ts
API:        Backend: /api/[feature] (NestJS controllers)
Data:       Prisma ORM (backend/src/modules/[feature]/[feature].service.ts)
```

**Flujo de datos:**
```
Screen ‚Üí Component ‚Üí Hook ‚Üí Service (lib/api/) ‚Üí Backend Endpoint ‚Üí Prisma Service ‚Üí Database
```

### Estructura de Carpetas por Feature

```
app/
‚îî‚îÄ‚îÄ [feature]/
    ‚îî‚îÄ‚îÄ page.tsx                    # Screen (p√°gina Next.js)

components/
‚îî‚îÄ‚îÄ [feature]/                     # Componentes del feature
    ‚îú‚îÄ‚îÄ [feature]-header.tsx
    ‚îú‚îÄ‚îÄ [feature]-table.tsx
    ‚îú‚îÄ‚îÄ [feature]-form.tsx
    ‚îî‚îÄ‚îÄ index.ts                   # Barrel export

lib/
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ use-[feature].ts          # Custom hook con React Query
‚îî‚îÄ‚îÄ api/
    ‚îî‚îÄ‚îÄ [feature].ts              # Cliente API (axios)

backend/src/modules/
‚îî‚îÄ‚îÄ [feature]/
    ‚îú‚îÄ‚îÄ [feature].controller.ts  # Endpoint NestJS
    ‚îú‚îÄ‚îÄ [feature].service.ts      # L√≥gica de negocio
    ‚îî‚îÄ‚îÄ dto/
        ‚îî‚îÄ‚îÄ [feature].dto.ts      # DTOs de validaci√≥n
```

### Servicios Backend

1. **BaseService Obligatorio**:
   - ‚úÖ Todos los servicios deben extender `BaseService<T, CreateDto, UpdateDto>`
   - ‚úÖ Usar generics: `<T, CreateInput, UpdateInput>`
   - ‚úÖ Ejemplo: `PastoresService extends BaseService<Pastor, CreatePastorDto, UpdatePastorDto>`

2. **PrismaService**:
   - ‚úÖ Usar `PrismaService` para acceso a datos
   - ‚úÖ NO usar SQL crudo, siempre usar Prisma ORM
   - ‚úÖ Usar tipos generados de Prisma

3. **Logger Obligatorio**:
   - ‚úÖ Inyectar `Logger` de NestJS
   - ‚úÖ Usar `this.logger.log()`, `this.logger.error()`, `this.logger.warn()`
   - ‚ùå NUNCA usar `console.log()` en servicios backend

4. **Exportaci√≥n**:
   - ‚úÖ Servicios deben estar exportados desde el m√≥dulo correspondiente
   - ‚úÖ Usar barrel exports cuando sea apropiado

### Servicios Frontend (lib/api/)

1. **Estructura**:
   - ‚úÖ Un archivo por feature: `lib/api/[feature].ts`
   - ‚úÖ Usar axios con configuraci√≥n centralizada
   - ‚úÖ Exportar funciones nombradas, no default

2. **Ejemplo**:
   ```typescript
   // lib/api/pagos.ts
   import { apiClient } from './client'
   
   export const pagosApi = {
     getAllPagos: (page: number, limit: number, filters?: PagosFilters) =>
       apiClient.get<PagosResponse>('/api/pagos', { params: { page, limit, ...filters } }),
     
     getById: (id: string) =>
       apiClient.get<Pago>(`/api/pagos/${id}`),
   }
   ```

### Principios SOLID

1. **Single Responsibility (SRP)**:
   - ‚úÖ Cada archivo tiene UNA responsabilidad
   - ‚úÖ Componentes peque√±os y enfocados
   - ‚úÖ Servicios con responsabilidad √∫nica

2. **Open/Closed (OCP)**:
   - ‚úÖ `BaseService` como n√∫cleo extensible
   - ‚úÖ Abierto para extensi√≥n, cerrado para modificaci√≥n
   - ‚úÖ Usar herencia y composici√≥n

3. **Liskov Substitution (LSP)**:
   - ‚úÖ Respetar interfaces y contratos
   - ‚úÖ Las clases hijas deben poder sustituir a las padres
   - ‚úÖ Ejemplo: Servicios que extienden `BaseService`

4. **Interface Segregation (ISP)**:
   - ‚úÖ Interfaces peque√±as y espec√≠ficas
   - ‚úÖ No forzar implementaci√≥n de m√©todos no usados
   - ‚úÖ Ejemplo: `IBaseService<T, CreateDto, UpdateDto>`

5. **Dependency Inversion (DIP)**:
   - ‚úÖ Depender de abstracciones, no de implementaciones
   - ‚úÖ Inyectar dependencias (DI de NestJS)
   - ‚úÖ Usar interfaces para contratos

### Reusabilidad (DRY - Don't Repeat Yourself)

1. **Nada Duplicado**:
   - ‚úÖ Extraer funciones repetidas a `lib/utils/`
   - ‚úÖ Crear componentes compartidos en `components/ui/`
   - ‚úÖ Usar hooks personalizados para l√≥gica repetida

2. **Componentes Gen√©ricos**:
   - ‚úÖ Tablas gen√©ricas cuando sea posible
   - ‚úÖ Formularios gen√©ricos con configuraci√≥n
   - ‚úÖ Dialogs gen√©ricos reutilizables

3. **Ejemplos de Reutilizaci√≥n**:
   ```typescript
   // ‚úÖ BIEN: Componente gen√©rico
   <DataTable<T>
     data={items}
     columns={columns}
     onRowClick={handleRowClick}
   />
   
   // ‚ùå MAL: Duplicar c√≥digo de tabla
   <PagosTable />
   <InscripcionesTable />
   <PastoresTable />
   ```

4. **Utilidades Compartidas**:
   - ‚úÖ Funciones de formato en `lib/utils/format.ts`
   - ‚úÖ Validaciones en `lib/utils/validation.ts`
   - ‚úÖ Helpers de fecha en `lib/utils/date.ts`

### Componentes Gen√©ricos

1. **Tablas**:
   - ‚úÖ Crear componente `DataTable<T>` gen√©rico
   - ‚úÖ Configurar columnas mediante props
   - ‚úÖ Reutilizar para diferentes entidades

2. **Formularios**:
   - ‚úÖ Usar React Hook Form con configuraci√≥n
   - ‚úÖ Crear componentes de campo gen√©ricos
   - ‚úÖ Validaci√≥n con Zod schemas reutilizables

3. **Dialogs**:
   - ‚úÖ Crear `ConfirmDialog` gen√©rico
   - ‚úÖ Crear `FormDialog<T>` gen√©rico
   - ‚úÖ Reutilizar para diferentes acciones

### Validaci√≥n de Arquitectura

```bash
# Verificar estructura de capas
find app -name "page.tsx" | head -5
find components -type d -maxdepth 1
find lib/hooks -name "use-*.ts" | head -5
find lib/api -name "*.ts" | head -5

# Verificar que servicios extienden BaseService
grep -r "extends BaseService" backend/src/modules/

# Verificar uso de Prisma (no SQL crudo)
grep -r "prisma\." backend/src/modules/ | head -10
```

---

## üîí SEGURIDAD Y BUENAS PR√ÅCTICAS

### Protecci√≥n de Credenciales y Secretos

1. **NUNCA Exponer Tokens, Claves o Secretos**:
   - ‚ùå NUNCA hardcodear tokens, API keys, o secretos en el c√≥digo
   - ‚ùå NUNCA commitear archivos `.env` con credenciales reales
   - ‚ùå NUNCA exponer tokens en URLs, logs, o respuestas HTTP
   - ‚úÖ Usar variables de entorno (`process.env`)
   - ‚úÖ Usar archivos `.env.example` para documentar variables necesarias
   - ‚úÖ Validar que variables de entorno est√©n configuradas en producci√≥n
   - ‚úÖ Usar servicios de gesti√≥n de secretos en producci√≥n (Vercel, AWS Secrets Manager)

2. **Validaci√≥n de Variables de Entorno**:
   ```typescript
   // ‚úÖ BIEN: Validar en bootstrap
   if (!process.env.JWT_SECRET || process.env.JWT_SECRET.length < 32) {
     logger.error('JWT_SECRET debe tener al menos 32 caracteres')
     process.exit(1)
   }
   
   // ‚ùå MAL: Usar directamente sin validar
   const secret = process.env.JWT_SECRET
   ```

3. **Manejo de Tokens**:
   - ‚úÖ Almacenar tokens en `localStorage` o `sessionStorage` (frontend)
   - ‚úÖ Enviar tokens solo en headers HTTP (`Authorization: Bearer <token>`)
   - ‚úÖ NUNCA exponer tokens en URLs, query params, o respuestas
   - ‚úÖ Invalidar tokens al hacer logout
   - ‚úÖ Implementar refresh tokens para renovaci√≥n segura

### Logging y Debugging

1. **NO usar console.log en Producci√≥n**:
   - ‚ùå NUNCA usar `console.log()`, `console.error()`, `console.warn()` en servicios backend
   - ‚úÖ Usar `Logger` de NestJS en backend: `this.logger.log()`, `this.logger.error()`
   - ‚úÖ En frontend, usar `console.log()` solo para debugging temporal
   - ‚úÖ Marcar logs temporales con `// TODO: remove` y fecha
   - ‚úÖ Usar niveles de log apropiados: `log`, `error`, `warn`, `debug`

2. **Logging Seguro**:
   ```typescript
   // ‚úÖ BIEN: Usar Logger de NestJS
   this.logger.log('Usuario autenticado:', { userId: user.id })
   this.logger.error('Error al procesar pago:', error)
   
   // ‚ùå MAL: Usar console.log
   console.log('Token:', token) // ‚ö†Ô∏è Expone token en logs
   console.log('Password:', password) // ‚ö†Ô∏è Expone password
   ```

3. **Sanitizaci√≥n de Logs**:
   - ‚úÖ NUNCA loguear passwords, tokens, o datos sensibles
   - ‚úÖ Loguear solo IDs o informaci√≥n no sensible
   - ‚úÖ Usar m√°scaras para datos sensibles: `****-****-****-1234`

### Validaci√≥n de Inputs

1. **Validaci√≥n Obligatoria**:
   - ‚úÖ Validar TODOS los inputs en backend (nunca confiar en frontend)
   - ‚úÖ Usar `class-validator` en DTOs de NestJS
   - ‚úÖ Usar `Zod` schemas en frontend para UX
   - ‚úÖ Validar tipos, formatos, rangos, y longitud
   - ‚úÖ Sanitizar inputs antes de procesar

2. **Ejemplo de Validaci√≥n Backend**:
   ```typescript
   // ‚úÖ BIEN: DTO con validaci√≥n
   export class CreateInscripcionDto {
     @IsEmail()
     @IsNotEmpty()
     email!: string
     
     @IsString()
     @MinLength(2)
     @MaxLength(100)
     nombre!: string
     
     @IsEnum(TipoPago)
     metodoPago!: TipoPago
   }
   ```

3. **Validaci√≥n Frontend**:
   ```typescript
   // ‚úÖ BIEN: Schema Zod
   const inscripcionSchema = z.object({
     email: z.string().email('Email inv√°lido'),
     nombre: z.string().min(2, 'M√≠nimo 2 caracteres'),
   })
   ```

### Manejo de Tokens y Sesiones

1. **Autenticaci√≥n Segura**:
   - ‚úÖ Usar JWT con expiraci√≥n corta (15-30 minutos)
   - ‚úÖ Implementar refresh tokens con expiraci√≥n larga (7-30 d√≠as)
   - ‚úÖ Validar tokens en cada request protegido
   - ‚úÖ Invalidar tokens al hacer logout
   - ‚úÖ Implementar blacklist de tokens revocados

2. **Almacenamiento de Tokens**:
   ```typescript
   // ‚úÖ BIEN: Frontend - localStorage para tokens
   localStorage.setItem('auth_token', token)
   
   // ‚úÖ BIEN: Backend - Validar token en cada request
   @UseGuards(JwtAuthGuard)
   @Get('profile')
   getProfile(@Request() req: AuthenticatedRequest) {
     return req.user // Token ya validado por el guard
   }
   ```

3. **Sesiones**:
   - ‚úÖ Implementar timeout de sesi√≥n
   - ‚úÖ Renovar tokens antes de expirar
   - ‚úÖ Manejar m√∫ltiples dispositivos si aplica
   - ‚úÖ Invalidar todas las sesiones al cambiar password

### Prevenci√≥n de SQL Injection

1. **Usar Prisma ORM Siempre**:
   - ‚úÖ NUNCA usar SQL crudo con concatenaci√≥n de strings
   - ‚úÖ Usar Prisma ORM para todas las queries
   - ‚úÖ Prisma previene SQL injection autom√°ticamente
   - ‚úÖ Usar par√°metros preparados si es necesario SQL crudo

2. **Ejemplo Seguro**:
   ```typescript
   // ‚úÖ BIEN: Usar Prisma (previene SQL injection)
   await prisma.inscripcion.findMany({
     where: {
       email: userEmail, // Prisma sanitiza autom√°ticamente
       estado: 'ACTIVA',
     },
   })
   
   // ‚ùå MAL: SQL crudo vulnerable
   const query = `SELECT * FROM inscripciones WHERE email = '${email}'`
   // ‚ö†Ô∏è Vulnerable a SQL injection
   ```

3. **Si es Necesario SQL Crudo**:
   ```typescript
   // ‚úÖ BIEN: Usar par√°metros preparados
   await prisma.$queryRaw`
     SELECT * FROM inscripciones WHERE email = ${email}
   `
   ```

### Protecci√≥n de Datos Sensibles

1. **No Exponer Datos Sensibles en Responses**:
   - ‚ùå NUNCA retornar passwords en respuestas
   - ‚ùå NUNCA retornar tokens completos
   - ‚ùå NUNCA retornar informaci√≥n financiera completa
   - ‚úÖ Usar DTOs de respuesta que excluyan campos sensibles
   - ‚úÖ Usar `@Exclude()` de class-transformer
   - ‚úÖ Retornar solo datos necesarios para el cliente

2. **Ejemplo de Response Seguro**:
   ```typescript
   // ‚úÖ BIEN: DTO de respuesta sin password
   export class UserResponseDto {
     id!: string
     email!: string
     nombre!: string
     @Exclude()
     password!: string // No se incluye en la respuesta
   }
   
   // En el controller
   return plainToInstance(UserResponseDto, user)
   ```

3. **Datos Sensibles a Proteger**:
   - ‚úÖ Passwords (nunca exponer, ni hasheados)
   - ‚úÖ Tokens JWT completos
   - ‚úÖ API keys y secretos
   - ‚úÖ Informaci√≥n financiera (n√∫meros de tarjeta completos)
   - ‚úÖ Informaci√≥n personal sensible (DNI completo, etc.)

### Checklist de Seguridad

- [ ] Verificar que no hay tokens/secretos hardcodeados
- [ ] Validar que todas las variables de entorno est√°n configuradas
- [ ] Verificar que no hay `console.log()` en producci√≥n
- [ ] Validar que todos los inputs est√°n validados en backend
- [ ] Verificar que tokens se manejan correctamente
- [ ] Confirmar que se usa Prisma ORM (no SQL crudo)
- [ ] Verificar que responses no exponen datos sensibles
- [ ] Revisar logs para asegurar que no exponen informaci√≥n sensible
- [ ] Validar que passwords nunca se retornan en responses
- [ ] Verificar que tokens nunca se exponen en URLs o logs

### Comandos de Verificaci√≥n

```bash
# Buscar posibles secretos hardcodeados
grep -r "password.*=" backend/src/ --include="*.ts" | grep -v "process.env"
grep -r "secret.*=" backend/src/ --include="*.ts" | grep -v "process.env"
grep -r "api.*key" backend/src/ --include="*.ts" | grep -v "process.env"

# Buscar console.log en producci√≥n
grep -r "console\." backend/src/modules/ --include="*.ts"

# Buscar SQL crudo (debe ser m√≠nimo)
grep -r "\$queryRaw\|queryRawUnsafe" backend/src/ --include="*.ts"

# Buscar passwords en responses
grep -r "password" backend/src/modules/ --include="*.dto.ts" | grep -v "@Exclude\|@Expose"
```

---

**√öltima actualizaci√≥n**: Diciembre 2025
**Versi√≥n del proyecto**: v0.1.1

No se permite any.

Todos los componentes deben tener interface de props.

Los servicios deben tener tipos expl√≠citos de par√°metros y retornos.

Los servicios deben usar generics del BaseService.

Usar unknown si se requiere, con type guards.