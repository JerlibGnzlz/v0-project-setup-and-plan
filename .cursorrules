# Reglas del Proyecto AMVA Digital

## üìã Estructura del Proyecto

Este es un monorepo con:
- **Frontend**: Next.js 16 (App Router) + React 19 + TypeScript
- **Backend**: NestJS + Prisma + PostgreSQL (Neon)
- **Mobile**: React Native (Expo) - en `amva-mobile/`

### Estructura de Carpetas

```
/
‚îú‚îÄ‚îÄ app/                    # Next.js App Router (p√°ginas)
‚îÇ   ‚îú‚îÄ‚îÄ admin/             # Panel administrativo
‚îÇ   ‚îú‚îÄ‚îÄ convencion/        # P√°ginas p√∫blicas de convenciones
‚îÇ   ‚îî‚îÄ‚îÄ noticias/          # P√°ginas p√∫blicas de noticias
‚îú‚îÄ‚îÄ components/            # Componentes React reutilizables
‚îÇ   ‚îú‚îÄ‚îÄ admin/            # Componentes del panel admin (modularizados)
‚îÇ   ‚îú‚îÄ‚îÄ ui/               # Componentes UI base (shadcn/ui)
‚îÇ   ‚îî‚îÄ‚îÄ [feature]/        # Componentes por feature
‚îú‚îÄ‚îÄ lib/                  # Utilidades y configuraciones
‚îÇ   ‚îú‚îÄ‚îÄ api/              # Clientes API (axios)
‚îÇ   ‚îú‚îÄ‚îÄ hooks/            # Custom React hooks
‚îÇ   ‚îî‚îÄ‚îÄ utils/            # Funciones utilitarias
‚îú‚îÄ‚îÄ backend/              # Backend NestJS
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modules/      # M√≥dulos NestJS (auth, inscripciones, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/       # Servicios y utilidades compartidas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prisma/       # Configuraci√≥n Prisma
‚îÇ   ‚îî‚îÄ‚îÄ prisma/           # Schema y migraciones
‚îî‚îÄ‚îÄ amva-mobile/          # App m√≥vil React Native
```

## üéØ Stack Tecnol√≥gico

### Frontend
- **Framework**: Next.js 16 (App Router)
- **UI**: React 19, Tailwind CSS, shadcn/ui (Radix UI)
- **Estado**: Zustand (auth), React Query (data fetching)
- **Formularios**: React Hook Form + Zod
- **Notificaciones**: Sonner (toast)
- **Iconos**: Lucide React

### Backend
- **Framework**: NestJS 10
- **ORM**: Prisma 5
- **Base de Datos**: PostgreSQL (Neon)
- **Autenticaci√≥n**: JWT (Passport.js)
- **Validaci√≥n**: class-validator + class-transformer
- **Colas**: Bull + Redis (notificaciones)
- **WebSockets**: Socket.io (notificaciones en tiempo real)
- **Upload**: Cloudinary + Multer
- **Email**: Nodemailer + SendGrid

## üìù Convenciones de C√≥digo

### TypeScript

1. **Strict Mode Gradual**: Habilitar opciones estrictas gradualmente
   - ‚úÖ `strictNullChecks: true`
   - ‚úÖ `noImplicitAny: true`
   - ‚úÖ `strictFunctionTypes: true`
   - ‚úÖ `noImplicitReturns: true`
   - ‚ö†Ô∏è `strictPropertyInitialization: false` (temporal)
   - ‚ö†Ô∏è `noUnusedLocals: false` (temporal)

2. **Eliminar `any`**: Siempre usar tipos espec√≠ficos o `unknown` con type guards
   ```typescript
   // ‚ùå MAL
   function process(data: any) { }
   
   // ‚úÖ BIEN
   function process(data: unknown) {
     if (typeof data === 'string') { }
   }
   ```

3. **Tipos Prisma**: Usar tipos generados de Prisma
   ```typescript
   import { Inscripcion, Pago } from '@prisma/client'
   import { Prisma } from '@prisma/client'
   ```

4. **Request Types**: Usar tipos espec√≠ficos para requests autenticados
   ```typescript
   import { AuthenticatedRequest } from '../auth/types/request.types'
   ```

### React/Next.js

1. **Componentes**: Usar `'use client'` solo cuando sea necesario
   - P√°ginas del admin: `'use client'`
   - Componentes UI: `'use client'` si usan hooks
   - Layouts: Sin `'use client'` si es posible

2. **Modularizaci√≥n**: Componentes grandes deben dividirse
   - M√°ximo ~300-400 l√≠neas por componente
   - Extraer l√≥gica a custom hooks
   - Usar barrel exports (`index.ts`)

3. **Hooks Personalizados**: 
   - Prefijo `use` (ej: `useInscripciones`, `usePagos`)
   - Encapsular l√≥gica de React Query
   - Usar `useSmartSync` para sincronizaci√≥n entre pesta√±as

4. **Nombres de Componentes**: PascalCase
   ```typescript
   // ‚úÖ BIEN
   export function PagosStatsDashboard() { }
   export function EditarInscripcionDialog() { }
   ```

5. **Props**: Usar interfaces para props
   ```typescript
   interface ComponentProps {
     id: string
     onUpdate?: (data: Data) => void
   }
   ```

### NestJS

1. **Estructura de M√≥dulos**:
   ```
   modules/
   ‚îú‚îÄ‚îÄ [feature]/
   ‚îÇ   ‚îú‚îÄ‚îÄ [feature].module.ts
   ‚îÇ   ‚îú‚îÄ‚îÄ [feature].controller.ts
   ‚îÇ   ‚îú‚îÄ‚îÄ [feature].service.ts
   ‚îÇ   ‚îú‚îÄ‚îÄ dto/
   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [feature].dto.ts
   ‚îÇ   ‚îî‚îÄ‚îÄ types/
   ‚îÇ       ‚îî‚îÄ‚îÄ [feature].types.ts
   ```

2. **DTOs**: 
   - Usar `class-validator` para validaci√≥n
   - Usar `@IsOptional()` para campos opcionales
   - Usar `@ValidateIf()` para validaciones condicionales
   - Agregar `!` (definite assignment) si es necesario

3. **Servicios**:
   - Inyectar `PrismaService` y otros servicios
   - Usar `Logger` para logs
   - Manejar errores con try/catch
   - Usar `unknown` para errores, no `any`

4. **Controladores**:
   - Usar guards (`@UseGuards(JwtAuthGuard)`)
   - Usar decoradores de validaci√≥n (`@Body()`, `@Param()`)
   - Tipar `req` con `AuthenticatedRequest`

5. **Eventos**: Usar EventEmitter2 para eventos as√≠ncronos
   ```typescript
   this.eventEmitter.emit(NotificationEventType.PAGO_VALIDADO, event)
   ```

## üé® Estilo y Formato

### Prettier
- Sin punto y coma (`semi: false`)
- Comillas simples (`singleQuote: true`)
- 2 espacios de indentaci√≥n
- 100 caracteres de ancho m√°ximo
- `proseWrap: "preserve"` (no agregar l√≠neas en blanco innecesarias)

### Nombres de Archivos
- **Componentes**: kebab-case (ej: `pagos-stats-dashboard.tsx`)
- **Hooks**: kebab-case (ej: `use-inscripciones.ts`)
- **Servicios Backend**: kebab-case (ej: `inscripciones.service.ts`)
- **DTOs**: kebab-case (ej: `inscripcion.dto.ts`)

### Nombres de Variables/Funciones
- **Variables**: camelCase
- **Funciones**: camelCase
- **Constantes**: UPPER_SNAKE_CASE
- **Tipos/Interfaces**: PascalCase
- **Enums**: PascalCase

## üîê Autenticaci√≥n y Autorizaci√≥n

1. **Tres tipos de usuarios**:
   - **Admin**: Panel administrativo (`/admin/*`)
   - **Pastor**: App m√≥vil (endpoints `/auth/pastor/*`)
   - **Invitado**: Web p√∫blica (endpoints `/auth/invitado/*`)

2. **Guards**:
   - `JwtAuthGuard`: Para admins
   - `PastorJwtAuthGuard`: Para pastores
   - `InvitadoJwtAuthGuard`: Para invitados

3. **Refresh Tokens**:
   - Admins: `/api/auth/refresh`
   - Pastores: `/api/auth/pastor/refresh` (IMPORTANTE: no `/api/auth/refresh`)
   - Invitados: `/api/auth/invitado/refresh`

## üìä Base de Datos (Prisma)

1. **Modelos principales**:
   - `User`: Administradores
   - `Pastor`: Estructura organizacional
   - `Invitado`: Participantes de convenciones
   - `Convencion`: Eventos/convenciones
   - `Inscripcion`: Registros a convenciones
   - `Pago`: Pagos de inscripciones
   - `NotificationHistory`: Historial de notificaciones

2. **Relaciones importantes**:
   - `Inscripcion` ‚Üí `Convencion` (many-to-one)
   - `Inscripcion` ‚Üí `Pago` (one-to-many)
   - `Inscripcion` ‚Üí `Invitado` (many-to-one)

3. **Origen de Registro**: Campo `origenRegistro` en `Inscripcion`
   - `'web'`: Desde landing page
   - `'dashboard'`: Desde panel admin
   - `'mobile'`: Desde app m√≥vil

## üîî Notificaciones

1. **Sistema de Notificaciones**:
   - Eventos as√≠ncronos con EventEmitter2
   - Cola de procesamiento con Bull
   - WebSockets para tiempo real (Socket.io)
   - Email con templates personalizados
   - Push notifications (Expo)

2. **Notificaciones para Admins**:
   - Se guardan en `NotificationHistory` (b√∫squeda por email)
   - Se env√≠an v√≠a `sendNotificationToAdmin()` en `NotificationsService`
   - Aparecen en la campanita del header (`NotificationsBell`)
   - WebSocket se conecta autom√°ticamente al autenticarse
   - Contador de no le√≠das se actualiza en tiempo real

3. **Tipos de Notificaciones**:
   - `nueva_inscripcion`: Cuando se crea una inscripci√≥n nueva
   - `pago_validado`: Cuando un admin valida un pago
   - `pago_rechazado`: Cuando un admin rechaza un pago
   - `pago_rehabilitado`: Cuando se rehabilita un pago rechazado
   - `inscripcion_confirmada`: Cuando todas las cuotas est√°n pagadas
   - `pago_recordatorio`: Recordatorio de pagos pendientes

4. **Eventos de Notificaciones**:
   - Todos los eventos deben incluir `nombre` y `apellido` en `data`
   - El constructor genera `inscripcionNombre` autom√°ticamente
   - Ejemplo: `PagoValidadoEvent`, `InscripcionCreadaEvent`, `InscripcionConfirmadaEvent`

5. **Templates de Email Personalizados**:
   - Todos los templates usan el nombre real del usuario
   - L√≥gica: `inscripcionNombre` ‚Üí `nombre + apellido` ‚Üí `nombre` ‚Üí `'Estimado/a participante'`
   - Templates personalizados: `getPagoValidadoTemplate`, `getInscripcionCreadaTemplate`, `getInscripcionConfirmadaTemplate`, `getPagoRecordatorioTemplate`

6. **WebSocket Notifications**:
   - Hook: `useWebSocketNotifications()` en frontend
   - Gateway: `NotificationsGateway` en backend
   - Token: Se obtiene de `localStorage.getItem('auth_token')`
   - Eventos: `notification`, `unread-count`, `connect`, `disconnect`
   - Invalidaci√≥n autom√°tica de queries al conectar/reconectar

7. **getUnreadCount**:
   - Busca primero si es admin (por email en `NotificationHistory`)
   - Luego busca si es pastor (por `pastorId`)
   - Retorna 0 si no encuentra usuario
   - Logging para debugging

## üéØ Patrones de Dise√±o

### Frontend
1. **Barrel Exports**: Usar `index.ts` para exportar componentes
   ```typescript
   // components/admin/pagos/index.ts
   export { PagosHeader } from './pagos-header'
   export { PagosStatsDashboard } from './pagos-stats-dashboard'
   ```

2. **Custom Hooks**: Encapsular l√≥gica de React Query
   ```typescript
   export function usePagos(page, limit, filters) {
     return useQuery({
       queryKey: ['pagos', page, limit, filters],
       queryFn: () => pagosApi.getAllPagos(page, limit, filters),
     })
   }
   ```

3. **Smart Sync**: Sincronizaci√≥n entre pesta√±as
   ```typescript
   useSmartSync() // En hooks que necesitan sincronizaci√≥n
   ```

### Backend
1. **BaseService**: Servicios CRUD gen√©ricos
   ```typescript
   export class PastoresService extends BaseService<Pastor, CreatePastorDto, UpdatePastorDto>
   ```

2. **Repository Pattern**: Para acceso a datos complejos
   ```typescript
   export class ConvencionRepository { }
   ```

3. **Event-Driven**: Usar eventos para acciones as√≠ncronas
   ```typescript
   @OnEvent(NotificationEventType.PAGO_VALIDADO)
   async handlePagoValidado(event: PagoValidadoEvent) { }
   ```

## üö´ Reglas de NO Hacer

1. **NO usar `any`**: Siempre usar tipos espec√≠ficos o `unknown`
2. **NO crear archivos temporales**: Eliminar `.original.tsx`, `.refactored.tsx`
3. **NO crear docs innecesarios**: Solo documentaci√≥n esencial
4. **NO mezclar l√≥gica de negocio en componentes**: Usar hooks o servicios
5. **NO hardcodear valores**: Usar variables de entorno
6. **NO ignorar errores**: Siempre manejar con try/catch y logging
7. **NO crear componentes > 400 l√≠neas**: Modularizar
8. **SIEMPRE hacer git status, add, commit y push despu√©s de cambios**: 
   - ‚úÖ SIEMPRE ejecutar `git status` para verificar cambios
   - ‚úÖ SIEMPRE ejecutar `git add .` para agregar todos los cambios
   - ‚úÖ SIEMPRE ejecutar `git commit` con un mensaje descriptivo
   - ‚úÖ SIEMPRE ejecutar `git push origin main` despu√©s del commit
   - ‚úÖ Hacer esto autom√°ticamente despu√©s de cualquier modificaci√≥n de c√≥digo
   - ‚úÖ El mensaje de commit debe ser descriptivo y claro

9. **NO modificar archivos auto-generados que aparecen como cambios pendientes**:
   - ‚ùå NUNCA modificar archivos como `*.tsbuildinfo`, `tsconfig.tsbuildinfo`, `.next/`, `dist/`, `build/`
   - ‚ùå NUNCA hacer commit de archivos que se generan autom√°ticamente
   - ‚úÖ Si aparecen cambios en archivos auto-generados, ignorarlos (est√°n en `.gitignore`)
   - ‚úÖ Si el usuario ve cambios pendientes despu√©s de cerrar/abrir Cursor, verificar que los archivos est√©n en `.gitignore`
   - ‚úÖ Archivos que NO deber√≠an aparecer como cambios:
     - `*.tsbuildinfo` (TypeScript build info)
     - `.next/` (Next.js build)
     - `dist/` (Backend build)
     - `node_modules/` (Dependencias)
     - `*.log` (Logs)
     - `.cache/`, `.tmp/` (Archivos temporales)

10. **Mantener estado limpio al cerrar/abrir Cursor**:
   - ‚úÖ SIEMPRE hacer `git add .`, `git commit` y `git push` antes de cerrar Cursor si hay cambios leg√≠timos
   - ‚úÖ Al abrir Cursor despu√©s de cerrarlo, NO deber√≠an aparecer cambios pendientes si previamente se hicieron todos los commits y push
   - ‚úÖ Si aparecen cambios pendientes al abrir Cursor despu√©s de hacer commit y push:
     - Verificar que los archivos est√©n en `.gitignore` (archivos auto-generados)
     - Ejecutar `git status` para ver qu√© archivos aparecen como modificados
     - Si son archivos auto-generados (`*.tsbuildinfo`, `.next/`, `dist/`, etc.), NO hacer commit de ellos
     - Si son archivos leg√≠timos que no deber√≠an estar modificados, verificar:
       - Que el √∫ltimo commit y push se completaron correctamente
       - Que no hay diferencias entre el working directory y el √∫ltimo commit
       - Ejecutar `git diff` para ver qu√© cambi√≥
     - Si los cambios son solo en archivos auto-generados, ejecutar `git restore .` o `git checkout .` para descartarlos
   - ‚úÖ El objetivo es que al abrir Cursor, el estado del repositorio est√© limpio y sincronizado con el remoto
   - ‚úÖ Si hay cambios leg√≠timos pendientes, hacer commit y push antes de cerrar Cursor

## ‚úÖ Mejores Pr√°cticas

1. **Error Handling**:
   ```typescript
   try {
     // c√≥digo
   } catch (error: unknown) {
     const errorMessage = error instanceof Error ? error.message : 'Error desconocido'
     this.logger.error('Error:', errorMessage)
     throw error
   }
   ```

2. **Null Checks**:
   ```typescript
   if (!inscripcion || !inscripcion.email) {
     return
   }
   ```

3. **Type Guards**:
   ```typescript
   function isString(value: unknown): value is string {
     return typeof value === 'string'
   }
   ```

4. **Logging**: Usar Logger de NestJS en backend
   ```typescript
   this.logger.log('‚úÖ Operaci√≥n exitosa')
   this.logger.error('‚ùå Error:', error)
   ```

5. **Validaci√≥n**: Validar en frontend Y backend
   - Frontend: React Hook Form + Zod
   - Backend: class-validator

## üì¶ Imports

1. **Orden de imports**:
   ```typescript
   // 1. React/Next.js
   import { useState, useEffect } from 'react'
   
   // 2. Librer√≠as externas
   import { toast } from 'sonner'
   
   // 3. Componentes UI
   import { Button } from '@/components/ui/button'
   
   // 4. Componentes del proyecto
   import { PagosHeader } from '@/components/admin/pagos'
   
   // 5. Hooks
   import { usePagos } from '@/lib/hooks/use-pagos'
   
   // 6. Utilidades
   import { cn } from '@/lib/utils'
   ```

2. **Path Aliases**: Usar `@/` para imports absolutos
   - `@/components` ‚Üí `components/`
   - `@/lib` ‚Üí `lib/`
   - `@/app` ‚Üí `app/`

## üîÑ Flujos Importantes

### Inscripciones
1. Usuario se inscribe desde web ‚Üí `origenRegistro: 'web'`
2. Se crea `Inscripcion` y `Invitado` (si no existe)
3. Se crean pagos autom√°ticamente (3 cuotas por defecto)
4. Se env√≠a notificaci√≥n a admins
5. Admin valida pagos ‚Üí se env√≠a notificaci√≥n al usuario

### Pagos
1. Usuario sube comprobante (drag & drop mejorado)
2. Admin valida/rechaza pago
3. Se env√≠a notificaci√≥n al usuario Y a todos los admins (v√≠a `sendNotificationToAdmin`)
4. Notificaciones aparecen en la campanita del header
5. Si todas las cuotas pagadas ‚Üí inscripci√≥n confirmada (con email personalizado)

## üé® UI/UX

1. **Componentes UI**: Usar shadcn/ui como base
2. **Temas**: Soporte dark/light mode
3. **Responsive**: Mobile-first approach
4. **Loading States**: Siempre mostrar skeletons o spinners
5. **Error States**: Mostrar mensajes claros con toast (Sonner)
6. **Feedback Visual**: Usar badges, icons, colores sem√°nticos
7. **Tablas Optimizadas**:
   - Usar `table-auto` o `table-fixed` con `<colgroup>` para control de anchos
   - Padding reducido (`p-2` en lugar de `p-3`) para tablas compactas
   - Tama√±os de fuente reducidos (`text-xs`, `text-[10px]`) para m√°s informaci√≥n
   - Sin scroll lateral: ajustar anchos de columnas para que quepan en el viewport
   - Badges y botones compactos para tablas con muchas columnas

## üìù Comentarios y Documentaci√≥n

1. **JSDoc**: Para funciones complejas
   ```typescript
   /**
    * Actualiza una inscripci√≥n
    * @param id - ID de la inscripci√≥n
    * @param dto - Datos a actualizar
    * @returns Inscripci√≥n actualizada
    */
   ```

2. **Comentarios**: Explicar el "por qu√©", no el "qu√©"
3. **README**: Mantener actualizado en cada m√≥dulo importante

## üîç Debugging

1. **Console Logs**: Usar prefijos descriptivos
   ```typescript
   console.log('[PagosPage] Respuesta recibida:', data)
   this.logger.log('‚úÖ Pago validado:', id)
   ```

2. **Error Messages**: Ser espec√≠ficos y √∫tiles
   ```typescript
   throw new BadRequestException('El correo ya est√° inscrito en esta convenci√≥n')
   ```

## üöÄ Performance

1. **React Query**: Usar `placeholderData` para evitar parpadeos
2. **Lazy Loading**: Cargar componentes pesados con `dynamic()`
3. **Image Optimization**: Usar `next/image` siempre
4. **Code Splitting**: Next.js lo hace autom√°ticamente

## üîí Seguridad

1. **Validaci√≥n**: Siempre validar en backend, frontend es UX
2. **Sanitizaci√≥n**: Sanitizar inputs antes de guardar
3. **Rate Limiting**: Usar ThrottlerModule en NestJS
4. **JWT Secrets**: M√≠nimo 32 caracteres en producci√≥n
5. **CORS**: Configurado en `main.ts`

## üìã Checklist para Nuevas Features

- [ ] Crear tipos TypeScript apropiados
- [ ] Validar en frontend (Zod) y backend (class-validator)
- [ ] Manejar errores apropiadamente
- [ ] Agregar logging
- [ ] Agregar notificaciones si aplica
- [ ] Modularizar componentes grandes
- [ ] Usar barrel exports
- [ ] Agregar loading/error states
- [ ] Probar en dark/light mode
- [ ] Verificar responsive

## üéØ Prioridades del Proyecto

1. **TypeScript Strict**: Habilitar gradualmente opciones estrictas ‚úÖ
2. **Modularizaci√≥n**: Dividir componentes grandes ‚úÖ
3. **Eliminar `any`**: Reemplazar con tipos espec√≠ficos ‚úÖ (en progreso)
4. **Notificaciones**: Sistema de notificaciones mejorado ‚úÖ
   - Campanita funcionando con WebSocket
   - Notificaciones para: inscripciones, pagos validados, pagos rechazados
   - Templates de email personalizados con nombres reales
5. **Mercado Pago**: Integraci√≥n opcional (Fase 2)

---

## üìß Templates de Email

1. **Personalizaci√≥n con Nombres Reales**:
   - Todos los templates deben usar el nombre real del usuario
   - L√≥gica de fallback: `inscripcionNombre` ‚Üí `nombre + apellido` ‚Üí `nombre` ‚Üí `'Estimado/a participante'`
   - Eventos deben incluir `nombre` y `apellido` en `data`

2. **Templates Disponibles**:
   - `getPagoValidadoTemplate`: Pago validado exitosamente
   - `getPagoRechazadoTemplate`: Pago rechazado con motivo
   - `getPagoRehabilitadoTemplate`: Pago rehabilitado
   - `getPagoRecordatorioTemplate`: Recordatorio de pagos pendientes (dise√±o urgente con alertas)
   - `getInscripcionCreadaTemplate`: Inscripci√≥n recibida exitosamente
   - `getInscripcionConfirmadaTemplate`: Inscripci√≥n confirmada (todas las cuotas pagadas)
   - `getInscripcionCanceladaTemplate`: Inscripci√≥n cancelada
   - `getInscripcionActualizadaTemplate`: Inscripci√≥n actualizada

3. **Tipos de Notificaciones en Templates**:
   - `pago_validado`: Tipo correcto (no `pagoValidado`)
   - `pago_rechazado`: Tipo correcto (no `pagoRechazado`)
   - `pago_recordatorio`: Tipo correcto (no `recordatorio_pago`)
   - `inscripcion_creada`: Tipo correcto
   - `inscripcion_confirmada`: Tipo correcto

## üé® Optimizaci√≥n de Tablas

1. **Tablas sin Scroll Lateral**:
   - Usar `<colgroup>` con anchos espec√≠ficos para cada columna
   - Padding reducido: `p-2` en lugar de `p-3`
   - Tama√±os de fuente: `text-xs` o `text-[10px]` para contenido compacto
   - Badges compactos: `text-[10px] px-1.5 py-0.5`
   - Botones peque√±os: `h-7 text-[10px] px-2`
   - Iconos reducidos: `size-3` o `size-4`

2. **Ejemplo de Tabla Optimizada**:
   ```tsx
   <table className="w-full table-auto">
     <colgroup>
       <col className="w-[40px]" />
       <col className="w-[160px]" />
       {/* m√°s columnas */}
     </colgroup>
     <thead>
       <tr>
         <th className="p-2 text-xs font-medium">Columna</th>
       </tr>
     </thead>
   </table>
   ```

---

## üîç AUDITOR√çA Y CALIDAD DE C√ìDIGO

### Auditor√≠a del Service Layer (CR√çTICO)

1. **BaseService Obligatorio**: Todos los servicios deben extender `BaseService<T, CreateDto, UpdateDto>` cuando sea posible
2. **Logger Obligatorio**: Usar `Logger` de NestJS, NUNCA `console.log()` en servicios backend
3. **Tipos Expl√≠citos**: Todos los m√©todos deben tener tipos expl√≠citos de par√°metros y retornos

### Auditor√≠a de Componentes

1. **Interfaces de Props**: Todos los componentes deben tener interfaces para props
2. **Optimizaci√≥n**: Usar `useCallback`, `useMemo`, `React.memo` donde corresponde
3. **Estados**: Siempre mostrar estados de loading y empty

### Revisi√≥n de Hooks

1. **No console.log en producci√≥n**: Solo para debugging temporal (marcar con `// TODO: remove`)
2. **Usar servicios**: Usar servicios de `lib/api/`, no llamadas directas
3. **Query Keys**: Usar estructura consistente `['feature', 'subfeature', id]`

### Revisi√≥n Arquitect√≥nica

1. **Flujo**: `Screen ‚Üí Component ‚Üí Hook ‚Üí Service ‚Üí Backend ‚Üí Database`
2. **Servicios**: Extender `BaseService`, usar `PrismaService`, inyectar `Logger`
3. **Rutas API**: Backend `/api/[feature]`, Frontend `lib/api/[feature].ts`
4. **Base de Datos**: Usar Prisma ORM siempre, no SQL crudo

### C√≥digo No Usado

1. **Imports/Variables**: NO dejar sin usar, ejecutar `npm run lint`
2. **C√≥digo comentado**: NO dejar sin prop√≥sito, marcar con `// TODO: remove` si es temporal

### Checklist de Auditor√≠a Peri√≥dica

- [ ] Verificar que todos los servicios extienden BaseService
- [ ] Buscar y eliminar `console.log()` en producci√≥n
- [ ] Verificar que todos los servicios usan `Logger`
- [ ] Buscar componentes duplicados
- [ ] Verificar interfaces de props en todos los componentes
- [ ] Buscar uso de `any` en c√≥digo
- [ ] Ejecutar `npm run lint` y corregir errores
- [ ] Ejecutar `npm run build` y corregir errores TypeScript

---

## üèóÔ∏è ARQUITECTURA Y DISE√ëO

### Patr√≥n en Capas (Obligatorio)

```
Screen:     /app/[feature]/page.tsx
Component:  /components/[feature]/
Hook:       /lib/hooks/use-[feature].ts
Service:    /lib/api/[feature].ts
API:        Backend: /api/[feature] (NestJS)
Data:       Prisma ORM (backend/src/modules/[feature]/[feature].service.ts)
```

**Flujo:** `Screen ‚Üí Component ‚Üí Hook ‚Üí Service ‚Üí Backend ‚Üí Prisma ‚Üí Database`

### Servicios Backend

1. **BaseService Obligatorio**: Extender `BaseService<T, CreateDto, UpdateDto>`
2. **Generics**: Usar `<T, CreateInput, UpdateInput>`
3. **PrismaService**: Usar Prisma ORM siempre (no SQL crudo)
4. **Logger**: Usar `Logger` de NestJS, nunca `console.log()`

### Principios SOLID

1. **Single Responsibility**: Cada archivo una responsabilidad
2. **Open/Closed**: BaseService como n√∫cleo extensible
3. **Liskov**: Respetar interfaces y contratos
4. **Interface Segregation**: Interfaces peque√±as y espec√≠ficas
5. **Dependency Inversion**: Depender de abstracciones (DI de NestJS)

### Reusabilidad (DRY)

1. **Nada Duplicado**: Extraer a `lib/utils/` o componentes compartidos
2. **Componentes Gen√©ricos**: Tablas, formularios y dialogs gen√©ricos cuando sea posible
3. **Utilidades**: Funciones compartidas en `lib/utils/`

### Componentes Gen√©ricos

- ‚úÖ Tablas: `DataTable<T>` gen√©rico
- ‚úÖ Formularios: Con React Hook Form y configuraci√≥n
- ‚úÖ Dialogs: `ConfirmDialog`, `FormDialog<T>` gen√©ricos

---

## üîí SEGURIDAD Y BUENAS PR√ÅCTICAS

### Protecci√≥n de Credenciales

1. **NUNCA Exponer Tokens, Claves o Secretos**:
   - ‚ùå NUNCA hardcodear tokens, API keys, o secretos
   - ‚ùå NUNCA commitear `.env` con credenciales reales
   - ‚ùå NUNCA exponer tokens en URLs, logs, o responses
   - ‚úÖ Usar variables de entorno (`process.env`)
   - ‚úÖ Validar variables de entorno en producci√≥n

2. **Manejo de Tokens**:
   - ‚úÖ Almacenar tokens en `localStorage`/`sessionStorage` (frontend)
   - ‚úÖ Enviar tokens solo en headers HTTP (`Authorization: Bearer <token>`)
   - ‚úÖ NUNCA exponer tokens en URLs o query params
   - ‚úÖ Invalidar tokens al hacer logout

### Logging Seguro

1. **NO usar console.log en Producci√≥n**:
   - ‚ùå NUNCA usar `console.log()` en servicios backend
   - ‚úÖ Usar `Logger` de NestJS: `this.logger.log()`, `this.logger.error()`
   - ‚úÖ En frontend, solo para debugging temporal (marcar con `// TODO: remove`)
   - ‚úÖ NUNCA loguear passwords, tokens, o datos sensibles

### Validaci√≥n de Inputs

1. **Validaci√≥n Obligatoria**:
   - ‚úÖ Validar TODOS los inputs en backend (nunca confiar en frontend)
   - ‚úÖ Usar `class-validator` en DTOs de NestJS
   - ‚úÖ Usar `Zod` schemas en frontend para UX
   - ‚úÖ Validar tipos, formatos, rangos, y longitud

### Manejo de Tokens y Sesiones

1. **Autenticaci√≥n Segura**:
   - ‚úÖ Usar JWT con expiraci√≥n corta (15-30 minutos)
   - ‚úÖ Implementar refresh tokens con expiraci√≥n larga
   - ‚úÖ Validar tokens en cada request protegido
   - ‚úÖ Invalidar tokens al hacer logout

### Prevenci√≥n de SQL Injection

1. **Usar Prisma ORM Siempre**:
   - ‚úÖ NUNCA usar SQL crudo con concatenaci√≥n de strings
   - ‚úÖ Usar Prisma ORM para todas las queries
   - ‚úÖ Prisma previene SQL injection autom√°ticamente

### Protecci√≥n de Datos Sensibles

1. **No Exponer en Responses**:
   - ‚ùå NUNCA retornar passwords en respuestas
   - ‚ùå NUNCA retornar tokens completos
   - ‚úÖ Usar DTOs de respuesta que excluyan campos sensibles
   - ‚úÖ Usar `@Exclude()` de class-transformer

### Checklist de Seguridad

- [ ] Verificar que no hay tokens/secretos hardcodeados
- [ ] Validar variables de entorno configuradas
- [ ] Verificar que no hay `console.log()` en producci√≥n
- [ ] Validar que todos los inputs est√°n validados
- [ ] Verificar que tokens se manejan correctamente
- [ ] Confirmar que se usa Prisma ORM (no SQL crudo)
- [ ] Verificar que responses no exponen datos sensibles

---

**√öltima actualizaci√≥n**: Diciembre 2025
**Versi√≥n del proyecto**: v0.1.1

No se permite any.

Todos los componentes deben tener interface de props.

Los servicios deben tener tipos expl√≠citos de par√°metros y retornos.

Los servicios deben usar generics del BaseService.

Usar unknown si se requiere, con type guards.

