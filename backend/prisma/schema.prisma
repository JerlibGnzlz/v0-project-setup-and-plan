generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String               @id @default(uuid())
  email          String               @unique
  password       String
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  nombre         String
  rol            UserRole             @default(ADMIN)
  avatar         String?
  deviceTokens   AdminDeviceToken[]
  passwordResets PasswordResetToken[]

  @@map("users")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model Convencion {
  id             String          @id @default(uuid())
  titulo         String
  descripcion    String?
  ubicacion      String
  activa         Boolean         @default(true)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  costo          Decimal         @default(0) @db.Decimal(10, 2)
  cupoMaximo     Int?            @map("cupo_maximo")
  fechaFin       DateTime        @map("fecha_fin")
  fechaInicio    DateTime        @map("fecha_inicio")
  imagenUrl      String?         @map("imagen_url")
  archivada      Boolean         @default(false)
  fechaArchivado DateTime?       @map("fecha_archivado")
  galeria        GaleriaImagen[]
  inscripciones  Inscripcion[]

  @@index([activa])
  @@index([fechaInicio])
  @@map("convenciones")
}

model Pastor {
  id                     String                @id @default(uuid())
  nombre                 String
  apellido               String
  email                  String?               @unique
  telefono               String?
  cargo                  String?
  activo                 Boolean               @default(true)
  createdAt              DateTime              @default(now()) @map("created_at")
  updatedAt              DateTime              @updatedAt @map("updated_at")
  biografia              String?
  fotoUrl                String?               @map("foto_url")
  sede                   String?
  ministerio             String?
  mostrarEnLanding       Boolean               @default(false) @map("mostrar_en_landing")
  orden                  Int                   @default(0)
  pais                   String?
  region                 String?
  tipo                   TipoPastor            @default(PASTOR)
  trayectoria            String?
  credencialesPastorales CredencialPastoral[]
  NotificationHistory    NotificationHistory[]
  auth                   PastorAuth?

  @@index([activo])
  @@index([tipo])
  @@index([mostrarEnLanding])
  @@index([sede])
  @@map("pastores")
}

model PastorAuth {
  id              String        @id @default(uuid())
  pastorId        String        @unique
  email           String        @unique
  password        String
  googleId        String?       @unique
  emailVerificado Boolean       @default(false) @map("email_verificado")
  ultimoLogin     DateTime?     @map("ultimo_login")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deviceTokens    DeviceToken[]
  pastor          Pastor        @relation(fields: [pastorId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([googleId])
  @@map("pastor_auth")
}

model CredencialPastoral {
  id                             String           @id @default(uuid())
  pastorId                       String           @map("pastor_id")
  numeroCredencial               String           @unique @map("numero_credencial")
  fechaEmision                   DateTime         @map("fecha_emision")
  fechaVencimiento               DateTime         @map("fecha_vencimiento")
  estado                         EstadoCredencial @default(VIGENTE)
  notificacionVencimientoEnviada Boolean          @default(false) @map("notificacion_vencimiento_enviada")
  fechaUltimaNotificacion        DateTime?        @map("fecha_ultima_notificacion")
  activa                         Boolean          @default(true)
  notas                          String?
  createdAt                      DateTime         @default(now()) @map("created_at")
  updatedAt                      DateTime         @updatedAt @map("updated_at")
  pastor                         Pastor           @relation(fields: [pastorId], references: [id], onDelete: Cascade)

  @@index([pastorId])
  @@index([estado])
  @@index([fechaVencimiento])
  @@index([activa])
  @@index([numeroCredencial])
  @@map("credenciales_pastorales")
}

model SolicitudCredencial {
  id                                                                                                        String                 @id @default(uuid())
  invitadoId                                                                                                String                 @map("invitado_id")
  tipo                                                                                                      String
  dni                                                                                                       String
  nombre                                                                                                    String
  apellido                                                                                                  String
  nacionalidad                                                                                              String?
  fechaNacimiento                                                                                           DateTime?              @map("fecha_nacimiento")
  motivo                                                                                                    String?
  estado                                                                                                    String                 @default("pendiente")
  observaciones                                                                                             String?
  credencialMinisterialId                                                                                   String?                @unique @map("credencial_ministerial_id")
  credencialCapellaniaId                                                                                    String?                @unique @map("credencial_capellania_id")
  createdAt                                                                                                 DateTime               @default(now()) @map("created_at")
  updatedAt                                                                                                 DateTime               @updatedAt @map("updated_at")
  aprobadaAt                                                                                                DateTime?              @map("aprobada_at")
  completadaAt                                                                                              DateTime?              @map("completada_at")
  credencialCapellania                                                                                      CredencialCapellania?
  credencialMinisterial                                                                                     CredencialMinisterial?
  credenciales_capellania_solicitudes_credenciales_credencial_capellania_idTocredenciales_capellania        CredencialCapellania?  @relation("solicitudes_credenciales_credencial_capellania_idTocredenciales_capellania", fields: [credencialCapellaniaId], references: [id])
  credenciales_ministeriales_solicitudes_credenciales_credencial_ministerial_idTocredenciales_ministeriales CredencialMinisterial? @relation("solicitudes_credenciales_credencial_ministerial_idTocredenciales_ministeriales", fields: [credencialMinisterialId], references: [id])
  invitado                                                                                                  Invitado               @relation(fields: [invitadoId], references: [id], onDelete: Cascade)

  @@index([invitadoId])
  @@index([estado])
  @@index([tipo])
  @@index([dni])
  @@map("solicitudes_credenciales")
}

model CredencialMinisterial {
  id                                                                                                      String               @id @default(uuid())
  apellido                                                                                                String
  nombre                                                                                                  String
  documento                                                                                               String               @unique
  nacionalidad                                                                                            String
  fechaNacimiento                                                                                         DateTime             @map("fecha_nacimiento")
  tipoPastor                                                                                              String               @default("PASTOR") @map("tipo_pastor")
  fechaVencimiento                                                                                        DateTime             @map("fecha_vencimiento")
  fotoUrl                                                                                                 String?              @map("foto_url")
  activa                                                                                                  Boolean              @default(true)
  createdAt                                                                                               DateTime             @default(now()) @map("created_at")
  updatedAt                                                                                               DateTime             @updatedAt @map("updated_at")
  invitadoId                                                                                              String?              @map("invitado_id")
  solicitudCredencialId                                                                                   String?              @unique @map("solicitud_credencial_id")
  invitado                                                                                                Invitado?            @relation(fields: [invitadoId], references: [id])
  solicitudCredencial                                                                                     SolicitudCredencial? @relation(fields: [solicitudCredencialId], references: [id])
  solicitudes_credenciales_solicitudes_credenciales_credencial_ministerial_idTocredenciales_ministeriales SolicitudCredencial? @relation("solicitudes_credenciales_credencial_ministerial_idTocredenciales_ministeriales")

  @@index([documento])
  @@index([fechaVencimiento])
  @@index([activa])
  @@index([invitadoId])
  @@map("credenciales_ministeriales")
}

model CredencialCapellania {
  id                                                                                                  String               @id @default(uuid())
  apellido                                                                                            String
  nombre                                                                                              String
  documento                                                                                           String               @unique
  nacionalidad                                                                                        String
  fechaNacimiento                                                                                     DateTime             @map("fecha_nacimiento")
  tipoCapellan                                                                                        String               @default("CAPELLAN") @map("tipo_capellan")
  fechaVencimiento                                                                                    DateTime             @map("fecha_vencimiento")
  fotoUrl                                                                                             String?              @map("foto_url")
  activa                                                                                              Boolean              @default(true)
  createdAt                                                                                           DateTime             @default(now()) @map("created_at")
  updatedAt                                                                                           DateTime             @updatedAt @map("updated_at")
  invitadoId                                                                                          String?              @map("invitado_id")
  solicitudCredencialId                                                                               String?              @unique @map("solicitud_credencial_id")
  invitado                                                                                            Invitado?            @relation(fields: [invitadoId], references: [id])
  solicitudCredencial                                                                                 SolicitudCredencial? @relation(fields: [solicitudCredencialId], references: [id])
  solicitudes_credenciales_solicitudes_credenciales_credencial_capellania_idTocredenciales_capellania SolicitudCredencial? @relation("solicitudes_credenciales_credencial_capellania_idTocredenciales_capellania")

  @@index([documento])
  @@index([fechaVencimiento])
  @@index([activa])
  @@index([invitadoId])
  @@map("credenciales_capellania")
}

model DeviceToken {
  id         String     @id @default(uuid())
  pastorId   String     @map("pastor_id")
  token      String     @unique
  platform   String
  deviceId   String?    @map("device_id")
  active     Boolean    @default(true)
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  pastorAuth PastorAuth @relation(fields: [pastorId], references: [pastorId], onDelete: Cascade)

  @@index([pastorId])
  @@index([token])
  @@map("device_tokens")
}

model AdminDeviceToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  platform  String
  deviceId  String?  @map("device_id")
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("admin_device_tokens")
}

model Invitado {
  id                        String                  @id @default(uuid())
  nombre                    String
  apellido                  String
  email                     String                  @unique
  telefono                  String?
  sede                      String?
  createdAt                 DateTime                @default(now()) @map("created_at")
  updatedAt                 DateTime                @updatedAt @map("updated_at")
  fotoUrl                   String?                 @map("foto_url")
  credencialesCapellania    CredencialCapellania[]
  credencialesMinisteriales CredencialMinisterial[]
  inscripciones             Inscripcion[]
  auth                      InvitadoAuth?
  solicitudesCredenciales   SolicitudCredencial[]

  @@index([email])
  @@map("invitados")
}

model InvitadoAuth {
  id              String                @id @default(uuid())
  invitadoId      String                @unique @map("invitado_id")
  email           String                @unique
  password        String
  googleId        String?               @unique
  emailVerificado Boolean               @default(false) @map("email_verificado")
  ultimoLogin     DateTime?             @map("ultimo_login")
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  invitado        Invitado              @relation(fields: [invitadoId], references: [id], onDelete: Cascade)
  deviceTokens    InvitadoDeviceToken[]

  @@index([email])
  @@index([googleId])
  @@map("invitado_auth")
}

model InvitadoDeviceToken {
  id           String       @id @default(uuid())
  invitadoId   String       @map("invitado_id")
  token        String       @unique
  platform     String
  deviceId     String?      @map("device_id")
  active       Boolean      @default(true)
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  invitadoAuth InvitadoAuth @relation(fields: [invitadoId], references: [invitadoId], onDelete: Cascade)

  @@index([invitadoId])
  @@index([token])
  @@map("invitado_device_tokens")
}

model Inscripcion {
  id               String     @id @default(uuid())
  nombre           String
  apellido         String
  email            String
  telefono         String?
  createdAt        DateTime   @default(now()) @map("created_at")
  convencionId     String     @map("convencion_id")
  estado           String     @default("pendiente")
  fechaInscripcion DateTime   @default(now()) @map("fecha_inscripcion")
  notas            String?
  sede             String?
  tipoInscripcion  String     @default("pastor") @map("tipo_inscripcion")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  numeroCuotas     Int        @default(3) @map("numero_cuotas")
  origenRegistro   String     @default("web") @map("origen_registro")
  documentoUrl     String?    @map("documento_url")
  codigoReferencia String?    @unique @map("codigo_referencia")
  invitadoId       String?    @map("invitado_id")
  pais             String?
  provincia        String?
  dni              String?    @db.VarChar(20)
  convencion       Convencion @relation(fields: [convencionId], references: [id], onDelete: Cascade)
  invitado         Invitado?  @relation(fields: [invitadoId], references: [id])
  pagos            Pago[]

  @@index([convencionId])
  @@index([estado])
  @@index([origenRegistro])
  @@index([codigoReferencia])
  @@index([invitadoId])
  @@index([dni], map: "idx_inscripciones_dni")
  @@map("inscripciones")
}

model GaleriaImagen {
  id               String      @id @default(uuid())
  titulo           String
  descripcion      String?
  imagenUrl        String      @map("imagen_url")
  categoria        String?
  convencionId     String?     @map("convencion_id")
  orden            Int         @default(0)
  activa           Boolean     @default(true)
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  tipo             TipoGaleria @default(IMAGEN)
  thumbnailTime    Float?      @map("thumbnail_time")
  videoEndTime     Float?      @map("video_end_time")
  videoOriginalUrl String?     @map("video_original_url")
  videoStartTime   Float?      @map("video_start_time")
  convencion       Convencion? @relation(fields: [convencionId], references: [id])

  @@index([categoria])
  @@index([tipo])
  @@map("galeria")
}

model Pago {
  id             String          @id @default(uuid())
  monto          Decimal         @db.Decimal(10, 2)
  estado         EstadoPago      @default(PENDIENTE)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  fechaPago      DateTime?       @map("fecha_pago")
  inscripcionId  String          @map("inscripcion_id")
  metodoPago     String          @map("metodo_pago")
  notas          String?
  referencia     String?
  numeroCuota    Int?            @map("numero_cuota")
  comprobanteUrl String?         @map("comprobante_url")
  auditorias     AuditoriaPago[]
  inscripcion    Inscripcion     @relation(fields: [inscripcionId], references: [id], onDelete: Cascade)

  @@index([inscripcionId])
  @@index([estado])
  @@index([numeroCuota])
  @@map("pagos")
}

model AuditoriaPago {
  id             String   @id @default(uuid())
  pagoId         String   @map("pago_id")
  inscripcionId  String   @map("inscripcion_id")
  accion         String
  estadoAnterior String?  @map("estado_anterior")
  estadoNuevo    String?  @map("estado_nuevo")
  usuarioId      String?  @map("usuario_id")
  motivo         String?
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")
  pago           Pago     @relation(fields: [pagoId], references: [id], onDelete: Cascade)

  @@index([pagoId])
  @@index([inscripcionId])
  @@index([usuarioId])
  @@index([accion])
  @@index([createdAt])
  @@map("auditoria_pagos")
}

model Noticia {
  id               String           @id @default(uuid())
  titulo           String
  slug             String           @unique
  extracto         String?
  contenido        String
  imagenUrl        String?          @map("imagen_url")
  categoria        CategoriaNoticia @default(ANUNCIO)
  autor            String?
  publicado        Boolean          @default(false)
  destacado        Boolean          @default(false)
  fechaPublicacion DateTime?        @map("fecha_publicacion")
  metaTitle        String?          @map("meta_title")
  metaDescription  String?          @map("meta_description")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  vistas           Int              @default(0)

  @@index([publicado])
  @@index([destacado])
  @@index([categoria])
  @@index([fechaPublicacion])
  @@index([slug])
  @@map("noticias")
}

model NotificationHistory {
  id           String    @id @default(uuid())
  pastorId     String    @map("pastor_id")
  email        String
  title        String
  body         String
  type         String
  data         Json?
  sentVia      String    @default("push") @map("sent_via")
  pushSuccess  Boolean   @default(false) @map("push_success")
  emailSuccess Boolean   @default(false) @map("email_success")
  read         Boolean   @default(false)
  readAt       DateTime? @map("read_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  pastor       Pastor    @relation(fields: [pastorId], references: [id], onDelete: Cascade)

  @@index([pastorId])
  @@index([email])
  @@index([type])
  @@index([read])
  @@index([createdAt])
  @@map("notification_history")
}

model Sede {
  id          String   @id @default(uuid())
  pais        String
  ciudad      String
  descripcion String
  imagenUrl   String   @map("imagen_url")
  bandera     String
  activa      Boolean  @default(true)
  orden       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([activa])
  @@index([orden])
  @@map("sedes")
}

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

enum TipoPastor {
  DIRECTIVA
  SUPERVISOR
  PRESIDENTE
  PASTOR
}

enum TipoGaleria {
  IMAGEN
  VIDEO
}

enum EstadoPago {
  PENDIENTE
  COMPLETADO
  CANCELADO
  REEMBOLSADO
}

enum CategoriaNoticia {
  ANUNCIO
  EVENTO
  ACTIVIDAD
  OPORTUNIDADES
  CAPACITACION
  COMUNICADO
}

enum EstadoCredencial {
  SIN_CREDENCIAL
  VIGENTE
  POR_VENCER
  VENCIDA
}
