generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String               @id @default(uuid())
  email          String               @unique
  password       String
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  nombre         String
  rol            UserRole             @default(ADMIN)
  avatar         String?
  passwordResets PasswordResetToken[]

  @@map("users")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model Convencion {
  id             String          @id @default(uuid())
  titulo         String
  descripcion    String?
  ubicacion      String
  activa         Boolean         @default(true)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  costo          Decimal         @default(0) @db.Decimal(10, 2)
  cupoMaximo     Int?            @map("cupo_maximo")
  fechaFin       DateTime        @map("fecha_fin")
  fechaInicio    DateTime        @map("fecha_inicio")
  imagenUrl      String?         @map("imagen_url")
  archivada      Boolean         @default(false)
  fechaArchivado DateTime?       @map("fecha_archivado")
  galeria        GaleriaImagen[]
  inscripciones  Inscripcion[]

  @@index([activa])
  @@index([fechaInicio])
  @@map("convenciones")
}

model Pastor {
  id                  String                @id @default(uuid())
  nombre              String
  apellido            String
  email               String?               @unique
  telefono            String?
  cargo               String?
  activo              Boolean               @default(true)
  createdAt           DateTime              @default(now()) @map("created_at")
  updatedAt           DateTime              @updatedAt @map("updated_at")
  biografia           String?
  fotoUrl             String?               @map("foto_url")
  sede                String?
  ministerio          String?
  mostrarEnLanding    Boolean               @default(false) @map("mostrar_en_landing")
  orden               Int                   @default(0)
  pais                String?
  region              String?
  tipo                TipoPastor            @default(PASTOR)
  trayectoria         String?
  auth                PastorAuth?
  NotificationHistory NotificationHistory[]

  @@index([activo])
  @@index([tipo])
  @@index([mostrarEnLanding])
  @@index([sede])
  @@map("pastores")
}

model PastorAuth {
  id              String        @id @default(uuid())
  pastorId        String        @unique
  email           String        @unique
  password        String
  googleId        String?       @unique
  emailVerificado Boolean       @default(false) @map("email_verificado")
  ultimoLogin     DateTime?     @map("ultimo_login")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  pastor          Pastor        @relation(fields: [pastorId], references: [id], onDelete: Cascade)
  deviceTokens    DeviceToken[]

  @@index([email])
  @@index([googleId])
  @@map("pastor_auth")
}

model DeviceToken {
  id        String   @id @default(uuid())
  pastorId  String   @map("pastor_id")
  token     String   @unique
  platform  String // 'ios' | 'android'
  deviceId  String?  @map("device_id")
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  pastorAuth PastorAuth @relation(fields: [pastorId], references: [pastorId], onDelete: Cascade)

  @@index([pastorId])
  @@index([token])
  @@map("device_tokens")
}

model Invitado {
  id            String        @id @default(uuid())
  nombre        String
  apellido      String
  email         String        @unique
  telefono      String?
  sede          String?
  fotoUrl       String?       @map("foto_url")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  auth          InvitadoAuth?
  inscripciones Inscripcion[]

  @@index([email])
  @@map("invitados")
}

model InvitadoAuth {
  id              String                @id @default(uuid())
  invitadoId      String                @unique @map("invitado_id")
  email           String                @unique
  password        String
  googleId        String?               @unique
  emailVerificado Boolean               @default(false) @map("email_verificado")
  ultimoLogin     DateTime?             @map("ultimo_login")
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  invitado        Invitado              @relation(fields: [invitadoId], references: [id], onDelete: Cascade)
  deviceTokens    InvitadoDeviceToken[]

  @@index([email])
  @@index([googleId])
  @@map("invitado_auth")
}

model InvitadoDeviceToken {
  id         String   @id @default(uuid())
  invitadoId String   @map("invitado_id")
  token      String   @unique
  platform   String // 'ios' | 'android'
  deviceId   String?  @map("device_id")
  active     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  invitadoAuth InvitadoAuth @relation(fields: [invitadoId], references: [invitadoId], onDelete: Cascade)

  @@index([invitadoId])
  @@index([token])
  @@map("invitado_device_tokens")
}

model Inscripcion {
  id               String     @id @default(uuid())
  nombre           String
  apellido         String
  email            String
  telefono         String?
  createdAt        DateTime   @default(now()) @map("created_at")
  convencionId     String     @map("convencion_id")
  estado           String     @default("pendiente")
  fechaInscripcion DateTime   @default(now()) @map("fecha_inscripcion")
  notas            String?
  sede             String?
  tipoInscripcion  String     @default("pastor") @map("tipo_inscripcion")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  numeroCuotas     Int        @default(3) @map("numero_cuotas")
  origenRegistro   String     @default("web") @map("origen_registro")
  documentoUrl     String?    @map("documento_url")
  codigoReferencia String?    @unique @map("codigo_referencia")
  invitadoId       String?    @map("invitado_id") // Relación opcional con invitado
  convencion       Convencion @relation(fields: [convencionId], references: [id], onDelete: Cascade)
  invitado         Invitado?  @relation(fields: [invitadoId], references: [id], onDelete: SetNull)
  pagos            Pago[]

  @@index([convencionId])
  @@index([estado])
  @@index([origenRegistro])
  @@index([codigoReferencia])
  @@index([invitadoId])
  @@map("inscripciones")
}

model GaleriaImagen {
  id               String      @id @default(uuid())
  titulo           String
  descripcion      String?
  imagenUrl        String      @map("imagen_url")
  categoria        String?
  convencionId     String?     @map("convencion_id")
  orden            Int         @default(0)
  activa           Boolean     @default(true)
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  tipo             TipoGaleria @default(IMAGEN)
  thumbnailTime    Float?      @map("thumbnail_time")
  videoEndTime     Float?      @map("video_end_time")
  videoOriginalUrl String?     @map("video_original_url")
  videoStartTime   Float?      @map("video_start_time")
  convencion       Convencion? @relation(fields: [convencionId], references: [id])

  @@index([categoria])
  @@index([tipo])
  @@map("galeria")
}

model Pago {
  id             String          @id @default(uuid())
  monto          Decimal         @db.Decimal(10, 2)
  estado         EstadoPago      @default(PENDIENTE)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  fechaPago      DateTime?       @map("fecha_pago")
  inscripcionId  String          @map("inscripcion_id")
  metodoPago     String          @map("metodo_pago")
  notas          String?
  referencia     String?
  numeroCuota    Int?            @map("numero_cuota")
  comprobanteUrl String?         @map("comprobante_url")
  inscripcion    Inscripcion     @relation(fields: [inscripcionId], references: [id], onDelete: Cascade)
  auditorias     AuditoriaPago[]

  @@index([inscripcionId])
  @@index([estado])
  @@index([numeroCuota])
  @@map("pagos")
}

model AuditoriaPago {
  id             String   @id @default(uuid())
  pagoId         String   @map("pago_id")
  inscripcionId  String   @map("inscripcion_id")
  accion         String // VALIDAR, RECHAZAR, REHABILITAR, ACTUALIZAR
  estadoAnterior String?  @map("estado_anterior")
  estadoNuevo    String?  @map("estado_nuevo")
  usuarioId      String?  @map("usuario_id")
  motivo         String?
  metadata       Json? // Información adicional (monto, referencia, etc.)
  createdAt      DateTime @default(now()) @map("created_at")
  pago           Pago     @relation(fields: [pagoId], references: [id], onDelete: Cascade)

  @@index([pagoId])
  @@index([inscripcionId])
  @@index([usuarioId])
  @@index([accion])
  @@index([createdAt])
  @@map("auditoria_pagos")
}

model Noticia {
  id               String           @id @default(uuid())
  titulo           String
  slug             String           @unique
  extracto         String?
  contenido        String
  imagenUrl        String?          @map("imagen_url")
  categoria        CategoriaNoticia @default(ANUNCIO)
  autor            String?
  publicado        Boolean          @default(false)
  destacado        Boolean          @default(false)
  fechaPublicacion DateTime?        @map("fecha_publicacion")
  metaTitle        String?          @map("meta_title")
  metaDescription  String?          @map("meta_description")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  vistas           Int              @default(0)

  @@index([publicado])
  @@index([destacado])
  @@index([categoria])
  @@index([fechaPublicacion])
  @@index([slug])
  @@map("noticias")
}

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

enum TipoPastor {
  DIRECTIVA
  SUPERVISOR
  PRESIDENTE
  PASTOR
}

enum TipoGaleria {
  IMAGEN
  VIDEO
}

enum EstadoPago {
  PENDIENTE
  COMPLETADO
  CANCELADO
  REEMBOLSADO
}

enum CategoriaNoticia {
  ANUNCIO
  EVENTO
  ACTIVIDAD
  OPORTUNIDADES
  CAPACITACION
  COMUNICADO
}

model NotificationHistory {
  id           String    @id @default(uuid())
  pastorId     String    @map("pastor_id")
  email        String
  title        String
  body         String
  type         String // 'pago_validado', 'inscripcion_confirmada', etc.
  data         Json? // Datos adicionales en formato JSON
  sentVia      String    @default("push") @map("sent_via") // 'push', 'email', 'both'
  pushSuccess  Boolean   @default(false) @map("push_success")
  emailSuccess Boolean   @default(false) @map("email_success")
  read         Boolean   @default(false)
  readAt       DateTime? @map("read_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  pastor Pastor @relation(fields: [pastorId], references: [id], onDelete: Cascade)

  @@index([pastorId])
  @@index([email])
  @@index([type])
  @@index([read])
  @@index([createdAt])
  @@map("notification_history")
}
